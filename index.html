<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Retention Dashboard - Real-time Sync</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .sync-dot.offline {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 24px;
        }
        
        .stat-icon.blue { background-color: #dbeafe; color: #2563eb; }
        .stat-icon.green { background-color: #dcfce7; color: #16a34a; }
        .stat-icon.yellow { background-color: #fef3c7; color: #d97706; }
        .stat-icon.red { background-color: #fee2e2; color: #dc2626; }
        .stat-icon.purple { background-color: #ede9fe; color: #7c3aed; }
        
        .stat-info h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .stat-info p {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn:hover {
            background-color: #1d4ed8;
        }
        
        .btn-success {
            background-color: #16a34a;
        }
        
        .btn-success:hover {
            background-color: #15803d;
        }
        
        .btn-secondary {
            background-color: #6b7280;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-warning {
            background-color: #f59e0b;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
        }
        
        .form-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .table-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .client-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .client-filter select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        tr.offboarded {
            background-color: #fef2f2;
            opacity: 0.8;
        }
        
        tr.offboarded:hover {
            background-color: #fee2e2;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-badge.healthy {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-badge.at-risk {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.critical {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-badge.offboarded {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        
        .month-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .offboard-date {
            font-size: 0.75rem;
            color: #dc2626;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .details {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .account-manager {
            font-size: 0.875rem;
            color: #2563eb;
            font-weight: 500;
        }
        
        .notes {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .notes:empty::before {
            content: "No notes";
            color: #9ca3af;
            font-style: italic;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin: 0 2px;
        }
        
        .edit-btn {
            color: #2563eb;
        }
        
        .edit-btn:hover {
            background-color: #dbeafe;
        }
        
        .delete-btn {
            color: #dc2626;
        }
        
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        
        .offboard-btn {
            color: #f59e0b;
        }
        
        .offboard-btn:hover {
            background-color: #fef3c7;
        }
        
        .reactivate-btn {
            color: #16a34a;
        }
        
        .reactivate-btn:hover {
            background-color: #dcfce7;
        }
        
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .alerts-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .alerts-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }
        
        .alerts-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .alert-urgent {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 12px;
            animation: pulse 2s infinite;
        }
        
        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .alert-item {
            padding: 16px;
            border-radius: 6px;
            border: 1px solid;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        
        .alert-item.critical {
            background-color: #fef2f2;
            border-color: #fecaca;
        }
        
        .alert-item.warning {
            background-color: #fffbeb;
            border-color: #fed7aa;
        }
        
        .alert-item.info {
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-content h4 {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .alert-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dismiss-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .bar-chart {
            display: flex;
            align-items: end;
            height: 200px;
            gap: 12px;
            padding: 20px 0;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, #e5e7eb, #3b82f6);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 20px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            padding-bottom: 8px;
        }
        
        .bar.healthy {
            background: linear-gradient(to top, #dcfce7, #16a34a);
        }
        
        .bar.at-risk {
            background: linear-gradient(to top, #fef3c7, #d97706);
        }
        
        .bar.critical {
            background: linear-gradient(to top, #fee2e2, #dc2626);
        }
        
        .bar.offboarded {
            background: linear-gradient(to top, #f3f4f6, #6b7280);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
            width: 100%;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .legend-color.healthy { background-color: #16a34a; }
        .legend-color.at-risk { background-color: #d97706; }
        .legend-color.critical { background-color: #dc2626; }
        .legend-color.offboarded { background-color: #6b7280; }
        
        .time-filter-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .time-filter-header {
            margin-bottom: 20px;
        }
        
        .time-filter-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #111827;
        }
        
        .time-filter-header p {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .time-filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background-color: #f9fafb;
            border-radius: 6px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
            background-color: white;
        }
        
        .time-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 6px;
            text-align: center;
        }
        
        .insight-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .insight-card:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .insight-card:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .insight-card h4 {
            font-size: 0.875rem;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .insight-card p {
            font-size: 0.875rem;
            margin: 0;
        }
        
        .insight-card strong {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .timeline-view {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .timeline-container {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-line {
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #10b981, #f59e0b, #ef4444);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 24px;
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            margin-left: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid white;
            box-shadow: 0 0 0 3px #10b981;
        }
        
        .timeline-item.warning::before {
            background: #f59e0b;
            box-shadow: 0 0 0 3px #f59e0b;
        }
        
        .timeline-item.critical::before {
            background: #ef4444;
            box-shadow: 0 0 0 3px #ef4444;
        }
        
        .timeline-date {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .timeline-content h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .account-manager-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .section-header {
            margin-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 16px;
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .section-header p {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .manager-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .manager-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .manager-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        
        .manager-card.no-manager {
            background: linear-gradient(135deg, #fef7f0 0%, #fef3e2 100%);
            border-color: #fed7aa;
        }
        
        .manager-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .manager-card.no-manager::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .manager-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .manager-info h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .manager-info .client-count {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .manager-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .manager-avatar.no-manager {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .manager-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .metric-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .metric-value.health-score {
            color: #059669;
        }
        
        .metric-value.retention-rate {
            color: #3b82f6;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .client-distribution {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .distribution-item {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .distribution-item.healthy {
            background: #dcfce7;
            color: #166534;
        }
        
        .distribution-item.at-risk {
            background: #fef3c7;
            color: #92400e;
        }
        
        .distribution-item.critical {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .distribution-item.offboarded {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .manager-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-link {
            flex: 1;
            padding: 8px 12px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s;
        }
        
        .action-link:hover {
            background: #1d4ed8;
            color: white;
        }
        
        .action-link.secondary {
            background: #6b7280;
        }
        
        .action-link.secondary:hover {
            background: #4b5563;
        }
        
        .no-managers-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .hidden {
            display: none;
        }

        .join-date {
            font-size: 0.75rem;
            color: #059669;
            font-weight: 500;
            margin-top: 4px;
        }

        /* Modal styles for offboard confirmation */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal h3 {
            margin-bottom: 16px;
            color: #111827;
        }

        .modal p {
            margin-bottom: 20px;
            color: #6b7280;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Sync Indicator -->
    <div class="sync-indicator">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-status">Connected</span>
    </div>

    <!-- Offboard Modal -->
    <div id="offboard-modal" class="modal">
        <div class="modal-content">
            <h3>🏃‍♂️ Offboard Client</h3>
            <p>Are you sure you want to offboard <strong id="offboard-client-name"></strong>? This will mark them as inactive but preserve all their data.</p>
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Offboard Date:</label>
                <input type="date" id="offboard-date" style="width: 100%;">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeOffboardModal()">Cancel</button>
                <button class="btn btn-warning" onclick="confirmOffboard()">Offboard Client</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Client Retention Dashboard</h1>
            <p>Monitor client health scores and retention metrics</p>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">👥</div>
                <div class="stat-info">
                    <h3>Total Clients</h3>
                    <p id="total-clients">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">✓</div>
                <div class="stat-info">
                    <h3>Active & Healthy</h3>
                    <p id="healthy-clients" style="color: #16a34a;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow">⚠</div>
                <div class="stat-info">
                    <h3>At Risk</h3>
                    <p id="at-risk-clients" style="color: #d97706;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">📉</div>
                <div class="stat-info">
                    <h3>Critical</h3>
                    <p id="critical-clients" style="color: #dc2626;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">🏃‍♂️</div>
                <div class="stat-info">
                    <h3>Offboarded</h3>
                    <p id="offboarded-clients" style="color: #7c3aed;">0</p>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section" id="alerts-section">
            <div class="alerts-header">
                <span style="font-size: 24px;">🔔</span>
                <h2>Active Alerts (<span id="alert-count">0</span>)</h2>
                <span class="alert-urgent" id="urgent-badge" style="display: none;">0 Urgent</span>
            </div>
            <div class="alerts-grid" id="alerts-container">
                <!-- Alerts will be inserted here -->
            </div>
        </div>

        <!-- Time Frame Analysis -->
        <div class="time-filter-section">
            <div class="time-filter-header">
                <h3>📅 Time Analysis</h3>
                <p>Analyze client retention across different time periods</p>
            </div>
            <div class="time-filter-controls">
                <div class="filter-group">
                    <label>Time Period:</label>
                    <select id="time-period" onchange="updateTimeFrame()">
                        <option value="lifetime">Lifetime (All Time)</option>
                        <option value="12months">Last 12 Months</option>
                        <option value="6months">Last 6 Months</option>
                        <option value="3months">Last 3 Months</option>
                        <option value="1month">Last Month</option>
                        <option value="current">Current Period</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>View Type:</label>
                    <select id="view-type" onchange="updateTimeFrame()">
                        <option value="summary">Summary View</option>
                        <option value="timeline">Client Timeline</option>
                        <option value="trends">Trend Analysis</option>
                    </select>
                </div>
            </div>
            <div class="time-insights" id="time-insights">
                <!-- Insights will be populated here -->
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3>Health Score Overview</h3>
                <div class="chart-container" id="score-chart">
                    <!-- Chart will be generated here -->
                </div>
            </div>
            <div class="chart-card">
                <h3>Client Distribution</h3>
                <div class="chart-container" id="distribution-chart">
                    <!-- Chart will be generated here -->
                </div>
            </div>
        </div>

        <!-- Add Client Button -->
        <button class="btn" onclick="toggleForm()">
            ➕ Add Client
        </button>

        <!-- Add Client Form -->
        <div class="form-section hidden" id="client-form">
            <h3 style="margin-bottom: 16px;" id="form-title">Add New Client</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="name" placeholder="Enter client name">
                </div>
                <div class="form-group">
                    <label>Join Date</label>
                    <input type="date" id="join-date" value="">
                </div>
                <div class="form-group">
                    <label>Account Manager</label>
                    <input type="text" id="account-manager" placeholder="Enter account manager name">
                </div>
                <div class="form-group">
                    <label>NPS Score (0-10)</label>
                    <input type="number" id="nps" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Session Show Up (%)</label>
                    <input type="number" id="showup" min="0" max="100" value="85">
                </div>
                <div class="form-group">
                    <label>Response Time (days)</label>
                    <input type="number" id="response" min="0" step="0.1" value="2">
                </div>
                <div class="form-group">
                    <label>Participation Level (0-10)</label>
                    <input type="number" id="participation" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Session Scheduled</label>
                    <select id="scheduled">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Survey Filled</label>
                    <select id="survey">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Notes</label>
                    <textarea id="notes" placeholder="Enter any notes about this client"></textarea>
                </div>
            </div>
            <div>
                <button class="btn btn-success" id="submit-btn" onclick="addClient()">Add Client</button>
                <button class="btn btn-secondary" onclick="cancelForm()">Cancel</button>
            </div>
        </div>

        <!-- Account Manager Performance Section -->
        <div class="account-manager-section">
            <div class="section-header">
                <h2>👥 Account Manager Performance</h2>
                <p>Track performance metrics and client health scores by account manager</p>
            </div>
            <div class="manager-cards-grid" id="manager-cards-grid">
                <!-- Manager cards will be inserted here -->
            </div>
        </div>

        <!-- Client Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>Client Health Scores</h2>
                <div class="client-filter">
                    <label>Filter:</label>
                    <select id="client-status-filter" onchange="updateTable()">
                        <option value="all">All Clients</option>
                        <option value="active">Active Only</option>
                        <option value="offboarded">Offboarded Only</option>
                    </select>
                    <select id="manager-filter" onchange="updateTable()" style="margin-left: 10px;">
                        <option value="all">All Managers</option>
                        <!-- Manager options will be populated dynamically -->
                    </select>
                </div>
            </div>
            <div>
                <table>
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Join Date & Month</th>
                            <th>Account Manager</th>
                            <th>NPS</th>
                            <th>Engagement</th>
                            <th>Health Score</th>
                            <th>Status</th>
                            <th>Details</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-table">
                        <!-- Clients will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDNMzO17wu4NOaR2TjT419f0IzB-pWzU5M",
            authDomain: "becontent-33415.firebaseapp.com",
            databaseURL: "https://becontent-33415-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "becontent-33415",
            storageBucket: "becontent-33415.firebasestorage.app",
            messagingSenderId: "967557303388",
            appId: "1:967557303388:web:b263a25fea91824710ea99",
            measurementId: "G-Z23YF3S7VQ"
        };

        // Initialize Firebase
        let database;
        let clientsRef;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            clientsRef = database.ref('clients');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Local clients array
        let clients = [];
        let dismissedAlerts = new Set();
        let currentEditingClientId = null;
        let currentOffboardingClientId = null;

        // Set default join date to today when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('join-date').value = today;
            document.getElementById('offboard-date').value = today;
        });

        // Calculate which month the client is in - FIXED VERSION
        function calculateClientMonth(joinDate, offboardDate = null) {
            if (!joinDate) return 0;
            
            const join = new Date(joinDate);
            const endDate = offboardDate ? new Date(offboardDate) : new Date();
            
            // Calculate the difference in months
            let months = (endDate.getFullYear() - join.getFullYear()) * 12;
            months += endDate.getMonth() - join.getMonth();
            
            // If we haven't reached the anniversary day yet, subtract one month
            if (endDate.getDate() < join.getDate()) {
                months--;
            }
            
            // Add 1 to get which month they're currently in (not how many have passed)
            return Math.max(1, months + 1);
        }

        // Calculate engagement score
        function calculateEngagementScore(client) {
            const sessionScore = client.sessionShowUp >= 90 ? 10 : client.sessionShowUp >= 60 ? 7.5 : 3;
            const responseScore = client.messageResponseTime <= 2 ? 10 : client.messageResponseTime <= 3 ? 7.5 : 3;
            const scheduleScore = client.sessionScheduled ? 10 : 3;
            const participationScore = client.participationLevel;
            const surveyScore = client.surveyFilled ? 10 : 3;

            return (sessionScore * 0.4) + (responseScore * 0.1) + (scheduleScore * 0.05) + (participationScore * 0.35) + (surveyScore * 0.1);
        }

        // Calculate health score
        function calculateHealthScore(client) {
            const npsScore = client.nps;
            const engagementScore = calculateEngagementScore(client);
            return (npsScore * 0.6) + (engagementScore * 0.4);
        }

        // Get health category
        function getHealthCategory(score, isOffboarded = false) {
            if (isOffboarded) return { color: 'offboarded', label: 'Offboarded' };
            if (score >= 8) return { color: 'healthy', label: 'Healthy' };
            if (score >= 7) return { color: 'at-risk', label: 'At Risk' };
            return { color: 'critical', label: 'Critical' };
        }

        // Offboard modal functions
        function openOffboardModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            currentOffboardingClientId = clientId;
            document.getElementById('offboard-client-name').textContent = client.name;
            document.getElementById('offboard-modal').style.display = 'block';
        }

        function closeOffboardModal() {
            document.getElementById('offboard-modal').style.display = 'none';
            currentOffboardingClientId = null;
        }

        function confirmOffboard() {
            if (!currentOffboardingClientId) return;

            const offboardDate = document.getElementById('offboard-date').value;
            if (!offboardDate) {
                alert('Please select an offboard date');
                return;
            }

            const client = clients.find(c => c.id === currentOffboardingClientId);
            if (!client) return;

            // Add offboard information
            const updatedClient = {
                ...client,
                isOffboarded: true,
                offboardDate: offboardDate,
                updatedAt: new Date().toISOString()
            };

            // Add timeline entry
            if (!updatedClient.timeline) {
                updatedClient.timeline = [];
            }
            
            updatedClient.timeline.push({
                date: offboardDate,
                event: "Client Offboarded",
                score: calculateHealthScore(client),
                type: "offboard"
            });

            // Update in Firebase
            clientsRef.child(currentOffboardingClientId).set(updatedClient);

            closeOffboardModal();
            alert('Client offboarded successfully!');
        }

        // Reactivate client
        function reactivateClient(clientId) {
            if (!confirm('Are you sure you want to reactivate this client?')) return;

            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const updatedClient = {
                ...client,
                isOffboarded: false,
                reactivateDate: new Date().toISOString().split('T')[0],
                updatedAt: new Date().toISOString()
            };

            // Remove offboard date but keep it in timeline
            delete updatedClient.offboardDate;

            // Add timeline entry
            if (!updatedClient.timeline) {
                updatedClient.timeline = [];
            }
            
            updatedClient.timeline.push({
                date: new Date().toISOString().split('T')[0],
                event: "Client Reactivated",
                score: calculateHealthScore(client),
                type: "reactivate"
            });

            // Update in Firebase
            clientsRef.child(clientId).set(updatedClient);

            alert('Client reactivated successfully!');
        }

        // UPDATED RETENTION CALCULATION FUNCTIONS - Modified to show "Retention in Months"
        function calculateTimeInsights(period) {
            let totalMonths = 0;
            const healthChanges = [];
            
            // Calculate retention in months for ALL clients (including offboarded)
            clients.forEach(client => {
                if (client.joinDate) {
                    const joinDate = new Date(client.joinDate);
                    const endDate = client.isOffboarded && client.offboardDate ? 
                        new Date(client.offboardDate) : new Date();
                    
                    // Calculate months between join date and end date (offboard or current)
                    const monthsDiff = (endDate - joinDate) / (1000 * 60 * 60 * 24 * 30);
                    totalMonths += monthsDiff;
                }
                
                if (client.timeline && client.timeline.length > 1) {
                    const firstScore = client.timeline[0].score;
                    const lastScore = client.timeline[client.timeline.length - 1].score;
                    healthChanges.push(lastScore - firstScore);
                }
            });
            
            // Calculate actual retention rate
            const retentionData = calculateActualRetention(period);
            
            // Calculate average retention in months across ALL clients
            const avgRetentionMonths = clients.length > 0 ? (totalMonths / clients.length).toFixed(1) : 0;
            const avgHealthChange = healthChanges.length > 0 ? 
                healthChanges.reduce((a, b) => a + b, 0) / healthChanges.length : 0;
            const trendDirection = avgHealthChange > 0 ? 'Improving' : avgHealthChange < 0 ? 'Declining' : 'Stable';
            
            return {
                // CHANGED: avgRelationship becomes avgRetentionMonths
                avgRetentionMonths: `<strong>${avgRetentionMonths} months</strong>`,
                retentionRate: `<strong>${retentionData.rate}%</strong> (${retentionData.details})`,
                healthTrend: `<strong>${trendDirection} (${avgHealthChange > 0 ? '+' : ''}${avgHealthChange.toFixed(1)})</strong>`,
                riskAnalysis: `<strong>${clients.filter(c => !c.isOffboarded && calculateHealthScore(c) < 7).length}</strong> clients at risk`
            };
        }

        // New function to calculate actual retention rate
        function calculateActualRetention(period) {
            const currentDate = new Date();
            let periodStart;
            
            // Determine the period start date
            switch(period) {
                case '1month':
                    periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, currentDate.getDate());
                    break;
                case '3months':
                    periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth() - 3, currentDate.getDate());
                    break;
                case '6months':
                    periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth() - 6, currentDate.getDate());
                    break;
                case '12months':
                    periodStart = new Date(currentDate.getFullYear() - 1, currentDate.getMonth(), currentDate.getDate());
                    break;
                case 'current':
                    periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    break;
                default: // lifetime
                    return calculateLifetimeRetention();
            }
            
            // Find clients who were active at the start of the period
            const clientsAtPeriodStart = clients.filter(client => {
                const joinDate = new Date(client.joinDate);
                return joinDate <= periodStart;
            });
            
            // Count how many are still active (not offboarded) or were offboarded after the period
            const retainedClients = clientsAtPeriodStart.filter(client => {
                if (!client.isOffboarded) return true; // Still active
                
                if (client.offboardDate) {
                    const offboardDate = new Date(client.offboardDate);
                    return offboardDate > currentDate; // Offboarded after our analysis period
                }
                
                return false;
            });
            
            if (clientsAtPeriodStart.length === 0) {
                return { rate: 0, details: "No clients in period" };
            }
            
            const retentionRate = ((retainedClients.length / clientsAtPeriodStart.length) * 100).toFixed(0);
            
            return {
                rate: retentionRate,
                details: `${retainedClients.length}/${clientsAtPeriodStart.length} retained`
            };
        }

        // Calculate lifetime retention rate
        function calculateLifetimeRetention() {
            const totalClients = clients.length;
            const activeClients = clients.filter(c => !c.isOffboarded).length;
            
            if (totalClients === 0) {
                return { rate: 0, details: "No clients" };
            }
            
            const retentionRate = ((activeClients / totalClients) * 100).toFixed(0);
            
            return {
                rate: retentionRate,
                details: `${activeClients}/${totalClients} still active`
            };
        }

        // Time frame analysis functions
        function updateTimeFrame() {
            const period = document.getElementById('time-period').value;
            const viewType = document.getElementById('view-type').value;
            
            updateTimeInsights(period);
            updateTimelineView(viewType, period);
        }

        // UPDATED FUNCTION: Display "Retention in Months" instead of "Average Relationship"
        function updateTimeInsights(period) {
            const insights = calculateTimeInsights(period);
            const insightsContainer = document.getElementById('time-insights');
            
            insightsContainer.innerHTML = `
                <div class="insight-card">
                    <h4>📈 Retention in Months</h4>
                    <p>${insights.avgRetentionMonths}</p>
                </div>
                <div class="insight-card">
                    <h4>🎯 Client Retention</h4>
                    <p>${insights.retentionRate}</p>
                </div>
                <div class="insight-card">
                    <h4>⚡ Health Trend</h4>
                    <p>${insights.healthTrend}</p>
                </div>
                <div class="insight-card">
                    <h4>🚨 Risk Analysis</h4>
                    <p>${insights.riskAnalysis}</p>
                </div>`;
        }

        function updateTimelineView(viewType, period) {
            // Remove existing timeline
            const existingTimeline = document.querySelector('.timeline-view');
            if (existingTimeline) {
                existingTimeline.remove();
            }
            
            if (viewType === 'timeline' || viewType === 'trends') {
                createTimelineView(viewType, period);
            }
        }

        function createTimelineView(viewType, period) {
            const timelineDiv = document.createElement('div');
            timelineDiv.className = 'timeline-view';
            
            timelineDiv.innerHTML = `
                <div class="timeline-header">
                    <h3>${viewType === 'timeline' ? '📋 Client Timeline' : '📈 Trend Analysis'}</h3>
                    <span style="font-size: 0.875rem; color: #6b7280;">Showing ${period === 'lifetime' ? 'all historical data' : period}</span>
                </div>
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${generateTimelineItems(viewType, period)}
                </div>`;
            
            const chartsSection = document.querySelector('.charts-section');
            chartsSection.parentNode.insertBefore(timelineDiv, chartsSection);
        }

        function generateTimelineItems(viewType, period) {
            const allEvents = [];
            
            clients.forEach(client => {
                if (client.timeline) {
                    client.timeline.forEach(event => {
                        allEvents.push({
                            date: event.date,
                            event: event.event,
                            score: event.score,
                            type: event.type,
                            clientName: client.name,
                            clientId: client.id
                        });
                    });
                }
            });
            
            // Sort by date
            allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Filter by period if not lifetime
            if (period !== 'lifetime') {
                const cutoffDate = new Date();
                switch(period) {
                    case '1month':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 1);
                        break;
                    case '3months':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 3);
                        break;
                    case '6months':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 6);
                        break;
                    case '12months':
                        cutoffDate.setFullYear(cutoffDate.getFullYear() - 1);
                        break;
                }
                allEvents = allEvents.filter(event => new Date(event.date) >= cutoffDate);
            }
            
            let timelineHTML = '';
            allEvents.forEach(event => {
                const eventClass = event.score < 7 ? 'critical' : event.score < 8 ? 'warning' : '';
                const formattedDate = new Date(event.date).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                timelineHTML += `
                    <div class="timeline-item ${eventClass}">
                        <div class="timeline-date">${formattedDate}</div>
                        <div class="timeline-content">
                            <h4>${event.clientName}: ${event.event}</h4>
                            <p>Health Score: ${event.score.toFixed(1)} | Type: ${event.type}</p>
                        </div>
                    </div>`;
            });
            
            return timelineHTML || '<p style="color: #6b7280; padding: 20px;">No timeline data available for this period</p>';
        }

        // Update dashboard
        function updateDashboard() {
            const stats = { 
                total: clients.length, 
                healthy: 0, 
                atRisk: 0, 
                critical: 0, 
                offboarded: 0 
            };
            
            clients.forEach(client => {
                if (client.isOffboarded) {
                    stats.offboarded++;
                } else {
                    const score = calculateHealthScore(client);
                    const category = getHealthCategory(score);
                    if (category.color === 'healthy') stats.healthy++;
                    else if (category.color === 'at-risk') stats.atRisk++;
                    else stats.critical++;
                }
            });

            document.getElementById('total-clients').textContent = stats.total;
            document.getElementById('healthy-clients').textContent = stats.healthy;
            document.getElementById('at-risk-clients').textContent = stats.atRisk;
            document.getElementById('critical-clients').textContent = stats.critical;
            document.getElementById('offboarded-clients').textContent = stats.offboarded;

            updateManagerPerformance();
            updateTable();
            updateAlerts();
            updateCharts();
            updateTimeFrame();
        }

        // Calculate manager performance metrics
        function calculateManagerMetrics(managerName) {
            const managerClients = clients.filter(client => {
                if (managerName === 'Unassigned') {
                    return !client.accountManager || client.accountManager.trim() === '';
                }
                return client.accountManager === managerName;
            });

            if (managerClients.length === 0) {
                return {
                    totalClients: 0,
                    activeClients: 0,
                    avgHealthScore: 0,
                    retentionRate: 0,
                    distribution: { healthy: 0, atRisk: 0, critical: 0, offboarded: 0 }
                };
            }

            const activeClients = managerClients.filter(c => !c.isOffboarded);
            const offboardedClients = managerClients.filter(c => c.isOffboarded);
            
            // Calculate average health score for active clients only
            let totalHealthScore = 0;
            let healthyCount = 0;
            let atRiskCount = 0;
            let criticalCount = 0;

            activeClients.forEach(client => {
                const healthScore = calculateHealthScore(client);
                totalHealthScore += healthScore;
                
                const category = getHealthCategory(healthScore);
                if (category.color === 'healthy') healthyCount++;
                else if (category.color === 'at-risk') atRiskCount++;
                else criticalCount++;
            });

            const avgHealthScore = activeClients.length > 0 ? (totalHealthScore / activeClients.length) : 0;
            const retentionRate = managerClients.length > 0 ? ((activeClients.length / managerClients.length) * 100) : 0;

            return {
                totalClients: managerClients.length,
                activeClients: activeClients.length,
                avgHealthScore: avgHealthScore,
                retentionRate: retentionRate,
                distribution: {
                    healthy: healthyCount,
                    atRisk: atRiskCount,
                    critical: criticalCount,
                    offboarded: offboardedClients.length
                }
            };
        }

        // Get unique account managers
        function getUniqueManagers() {
            const managers = new Set();
            let hasUnassigned = false;

            clients.forEach(client => {
                if (client.accountManager && client.accountManager.trim() !== '') {
                    managers.add(client.accountManager.trim());
                } else {
                    hasUnassigned = true;
                }
            });

            const managersList = Array.from(managers).sort();
            if (hasUnassigned) {
                managersList.push('Unassigned');
            }

            return managersList;
        }

        // Update manager performance section
        function updateManagerPerformance() {
            const container = document.getElementById('manager-cards-grid');
            const managers = getUniqueManagers();

            if (managers.length === 0) {
                container.innerHTML = '<div class="no-managers-message">No account managers assigned yet. Assign managers to clients to see performance metrics.</div>';
                return;
            }

            container.innerHTML = '';

            managers.forEach(manager => {
                const metrics = calculateManagerMetrics(manager);
                const isUnassigned = manager === 'Unassigned';
                
                // Get manager initials for avatar
                const initials = isUnassigned ? '?' : manager.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                
                const card = document.createElement('div');
                card.className = `manager-card ${isUnassigned ? 'no-manager' : ''}`;
                card.onclick = () => filterByManager(manager);
                
                card.innerHTML = `
                    <div class="manager-header">
                        <div class="manager-info">
                            <h3>${isUnassigned ? 'Unassigned Clients' : manager}</h3>
                            <div class="client-count">${metrics.totalClients} total clients</div>
                        </div>
                        <div class="manager-avatar ${isUnassigned ? 'no-manager' : ''}">${initials}</div>
                    </div>
                    
                    <div class="manager-metrics">
                        <div class="metric-item">
                            <div class="metric-value health-score">${metrics.avgHealthScore.toFixed(1)}</div>
                            <div class="metric-label">Avg Health Score</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value retention-rate">${metrics.retentionRate.toFixed(0)}%</div>
                            <div class="metric-label">Retention Rate</div>
                        </div>
                    </div>
                    
                    <div class="client-distribution">
                        <div class="distribution-item healthy">
                            <div>${metrics.distribution.healthy}</div>
                            <div>Healthy</div>
                        </div>
                        <div class="distribution-item at-risk">
                            <div>${metrics.distribution.atRisk}</div>
                            <div>At Risk</div>
                        </div>
                        <div class="distribution-item critical">
                            <div>${metrics.distribution.critical}</div>
                            <div>Critical</div>
                        </div>
                        <div class="distribution-item offboarded">
                            <div>${metrics.distribution.offboarded}</div>
                            <div>Off.</div>
                        </div>
                    </div>
                    
                    <div class="manager-actions">
                        <a href="#" class="action-link" onclick="event.stopPropagation(); filterByManager('${manager}')">View Clients</a>
                        <a href="#" class="action-link secondary" onclick="event.stopPropagation(); scrollToTable()">Go to Table</a>
                    </div>
                `;
                
                container.appendChild(card);
            });

            // Update manager filter dropdown
            updateManagerFilter();
        }

        // Update manager filter dropdown
        function updateManagerFilter() {
            const managerFilter = document.getElementById('manager-filter');
            const managers = getUniqueManagers();
            
            // Clear existing options except "All Managers"
            managerFilter.innerHTML = '<option value="all">All Managers</option>';
            
            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager === 'Unassigned' ? 'Unassigned Clients' : manager;
                managerFilter.appendChild(option);
            });
        }

        // Filter by manager
        function filterByManager(managerName) {
            const managerFilter = document.getElementById('manager-filter');
            managerFilter.value = managerName;
            updateTable();
            scrollToTable();
        }

        // Scroll to table
        function scrollToTable() {
            document.querySelector('.table-section').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Update alerts
        function updateAlerts() {
            const alertsContainer = document.getElementById('alerts-container');
            const alertsSection = document.getElementById('alerts-section');
            alertsContainer.innerHTML = '';
            let alertCount = 0;
            let urgentCount = 0;

            // Only show alerts for active clients
            const activeClients = clients.filter(c => !c.isOffboarded);

            activeClients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score);

                // Critical alerts
                if (category.color === 'critical' && !dismissedAlerts.has(`critical-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item critical';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Client is in critical status (${score.toFixed(1)})</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('critical-${client.id}', this)">✕</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                    urgentCount++;
                }

                // At-risk alerts
                if (category.color === 'at-risk' && !dismissedAlerts.has(`at-risk-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item warning';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Client is at risk (${score.toFixed(1)})</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('at-risk-${client.id}', this)">✕</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                // Low attendance alerts
                if (client.sessionShowUp < 60 && !dismissedAlerts.has(`attendance-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item info';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Low session attendance: ${client.sessionShowUp}%</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('attendance-${client.id}', this)">✕</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                // Slow response alerts
                if (client.messageResponseTime > 3 && !dismissedAlerts.has(`response-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item info';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Slow response time: ${client.messageResponseTime} days</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('response-${client.id}', this)">✕</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }
            });

            document.getElementById('alert-count').textContent = alertCount;
            document.getElementById('urgent-badge').style.display = urgentCount > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentCount + ' Urgent';
            
            // Hide alerts section if no alerts
            alertsSection.style.display = alertCount > 0 ? 'block' : 'none';
        }

        // Dismiss alert
        function dismissAlert(alertId, button) {
            dismissedAlerts.add(alertId);
            button.parentElement.remove();
            const alertCount = document.querySelectorAll('.alert-item').length;
            document.getElementById('alert-count').textContent = alertCount;
            
            const urgentAlerts = document.querySelectorAll('.alert-item.critical').length;
            document.getElementById('urgent-badge').style.display = urgentAlerts > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentAlerts + ' Urgent';
            
            // Hide alerts section if no alerts left
            if (alertCount === 0) {
                document.getElementById('alerts-section').style.display = 'none';
            }
        }

        // Update charts
        function updateCharts() {
            updateScoreChart();
            updateDistributionChart();
        }

        // Update score chart
        function updateScoreChart() {
            const chartContainer = document.getElementById('score-chart');
            chartContainer.innerHTML = '';

            if (clients.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">No clients to display</div>';
                return;
            }

            const barChart = document.createElement('div');
            barChart.className = 'bar-chart';

            clients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score, client.isOffboarded);
                
                const barContainer = document.createElement('div');
                barContainer.style.flex = '1';
                barContainer.style.position = 'relative';
                barContainer.style.height = '100%';
                
                const bar = document.createElement('div');
                bar.className = `bar ${category.color}`;
                bar.style.height = `${(score / 10 * 100)}%`;
                bar.textContent = client.isOffboarded ? 'OFF' : score.toFixed(1);
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = client.name.length > 10 ? client.name.substring(0, 10) + '...' : client.name;
                
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                barChart.appendChild(barContainer);
            });

            chartContainer.appendChild(barChart);
        }

        // Update distribution chart
        function updateDistributionChart() {
            const chartContainer = document.getElementById('distribution-chart');
            chartContainer.innerHTML = '';

            const stats = { healthy: 0, atRisk: 0, critical: 0, offboarded: 0 };
            
            clients.forEach(client => {
                if (client.isOffboarded) {
                    stats.offboarded++;
                } else {
                    const score = calculateHealthScore(client);
                    const category = getHealthCategory(score);
                    if (category.color === 'healthy') stats.healthy++;
                    else if (category.color === 'at-risk') stats.atRisk++;
                    else stats.critical++;
                }
            });

            const total = clients.length;
            if (total === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">No clients to display</div>';
                return;
            }

            const healthyPercent = (stats.healthy / total * 100);
            const atRiskPercent = (stats.atRisk / total * 100);
            const criticalPercent = (stats.critical / total * 100);
            const offboardedPercent = (stats.offboarded / total * 100);

            // Create pie chart visualization
            const pieContainer = document.createElement('div');
            pieContainer.style.width = '200px';
            pieContainer.style.height = '200px';
            pieContainer.style.margin = '0 auto';
            pieContainer.style.borderRadius = '50%';
            pieContainer.style.background = `conic-gradient(
                #16a34a 0% ${healthyPercent}%, 
                #d97706 ${healthyPercent}% ${healthyPercent + atRiskPercent}%, 
                #dc2626 ${healthyPercent + atRiskPercent}% ${healthyPercent + atRiskPercent + criticalPercent}%,
                #6b7280 ${healthyPercent + atRiskPercent + criticalPercent}% 100%)`;

            chartContainer.appendChild(pieContainer);

            // Add legend
            const legend = document.createElement('div');
            legend.className = 'chart-legend';
            
            const chartData = [
                { label: 'Healthy', count: stats.healthy, color: '#16a34a' },
                { label: 'At Risk', count: stats.atRisk, color: '#d97706' },
                { label: 'Critical', count: stats.critical, color: '#dc2626' },
                { label: 'Offboarded', count: stats.offboarded, color: '#6b7280' }
            ];

            chartData.forEach(item => {
                if (item.count > 0) {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = item.color;
                    
                    const text = document.createElement('span');
                    text.textContent = `${item.label} (${item.count})`;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(text);
                    legend.appendChild(legendItem);
                }
            });
            
            chartContainer.appendChild(legend);
        }

        // Update table
        function updateTable() {
            const tableBody = document.getElementById('client-table');
            const statusFilter = document.getElementById('client-status-filter').value;
            const managerFilter = document.getElementById('manager-filter').value;
            tableBody.innerHTML = '';

            let filteredClients = clients;
            
            // Apply status filter
            if (statusFilter === 'active') {
                filteredClients = filteredClients.filter(c => !c.isOffboarded);
            } else if (statusFilter === 'offboarded') {
                filteredClients = filteredClients.filter(c => c.isOffboarded);
            }
            
            // Apply manager filter
            if (managerFilter !== 'all') {
                if (managerFilter === 'Unassigned') {
                    filteredClients = filteredClients.filter(c => !c.accountManager || c.accountManager.trim() === '');
                } else {
                    filteredClients = filteredClients.filter(c => c.accountManager === managerFilter);
                }
            }

            filteredClients.forEach(client => {
                const healthScore = calculateHealthScore(client);
                const engagementScore = calculateEngagementScore(client);
                const category = getHealthCategory(healthScore, client.isOffboarded);
                const clientMonth = calculateClientMonth(client.joinDate, client.offboardDate);

                // Format join date
                const joinDate = client.joinDate ? new Date(client.joinDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : 'N/A';

                // Format offboard date if exists
                const offboardDate = client.offboardDate ? new Date(client.offboardDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : null;

                const row = document.createElement('tr');
                if (client.isOffboarded) {
                    row.className = 'offboarded';
                }
                
                row.innerHTML = `
                    <td>
                        <strong>${client.name}</strong>
                        <div class="join-date">Joined: ${joinDate}</div>
                        ${client.isOffboarded && offboardDate ? `<div class="offboard-date">Offboarded: ${offboardDate}</div>` : ''}
                    </td>
                    <td>
                        ${joinDate}
                        <span class="month-indicator">${getOrdinal(clientMonth)} Month</span>
                    </td>
                    <td>
                        <div class="account-manager">${client.accountManager || 'Not assigned'}</div>
                    </td>
                    <td>${client.nps.toFixed(1)}</td>
                    <td>${engagementScore.toFixed(1)}</td>
                    <td><strong>${client.isOffboarded ? 'N/A' : healthScore.toFixed(1)}</strong></td>
                    <td><span class="status-badge ${category.color}">${category.label}</span></td>
                    <td class="details">
                        Show Up: ${client.sessionShowUp}%<br>
                        Response: ${client.messageResponseTime}d<br>
                        Scheduled: ${client.sessionScheduled ? 'Yes' : 'No'}<br>
                        Participation: ${client.participationLevel}<br>
                        Survey: ${client.surveyFilled ? 'Yes' : 'No'}
                    </td>
                    <td>
                        <div class="notes">${client.notes || ''}</div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${!client.isOffboarded ? `
                                <button class="action-btn edit-btn" onclick="editClient('${client.id}')" title="Edit Client">✏️</button>
                                <button class="action-btn offboard-btn" onclick="openOffboardModal('${client.id}')" title="Offboard Client">🏃‍♂️</button>
                            ` : `
                                <button class="action-btn reactivate-btn" onclick="reactivateClient('${client.id}')" title="Reactivate Client">🔄</button>
                            `}
                            <button class="action-btn delete-btn" onclick="deleteClient('${client.id}')" title="Delete Client">🗑️</button>
                        </div>
                    </td>`;
                
                tableBody.appendChild(row);
            });
        }

        // Helper function to get ordinal numbers (1st, 2nd, 3rd, etc.)
        function getOrdinal(num) {
            const suffixes = ["th", "st", "nd", "rd"];
            const v = num % 100;
            return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        // Toggle form
        function toggleForm() {
            const form = document.getElementById('client-form');
            form.classList.toggle('hidden');
            
            // Reset form if opening fresh
            if (!form.classList.contains('hidden')) {
                resetForm();
            }
        }

        // Reset form to add mode
        function resetForm() {
            currentEditingClientId = null;
            document.getElementById('form-title').textContent = 'Add New Client';
            document.getElementById('submit-btn').textContent = 'Add Client';
            document.getElementById('submit-btn').onclick = addClient;
            
            // Clear form
            document.getElementById('name').value = '';
            document.getElementById('join-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('account-manager').value = '';
            document.getElementById('nps').value = '7';
            document.getElementById('showup').value = '85';
            document.getElementById('response').value = '2';
            document.getElementById('participation').value = '7';
            document.getElementById('scheduled').value = 'true';
            document.getElementById('survey').value = 'true';
            document.getElementById('notes').value = '';
        }

        // Cancel form
        function cancelForm() {
            const form = document.getElementById('client-form');
            form.classList.add('hidden');
            resetForm();
        }

        // Edit client
        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) {
                alert('Client not found');
                return;
            }

            if (client.isOffboarded) {
                alert('Cannot edit offboarded clients. Please reactivate first.');
                return;
            }

            currentEditingClientId = id;
            
            // Update form title and button
            document.getElementById('form-title').textContent = 'Edit Client';
            document.getElementById('submit-btn').textContent = 'Update Client';
            document.getElementById('submit-btn').onclick = updateClient;
            
            // Populate form with client data
            document.getElementById('name').value = client.name;
            document.getElementById('join-date').value = client.joinDate || '';
            document.getElementById('account-manager').value = client.accountManager || '';
            document.getElementById('nps').value = client.nps;
            document.getElementById('showup').value = client.sessionShowUp;
            document.getElementById('response').value = client.messageResponseTime;
            document.getElementById('participation').value = client.participationLevel;
            document.getElementById('scheduled').value = client.sessionScheduled.toString();
            document.getElementById('survey').value = client.surveyFilled.toString();
            document.getElementById('notes').value = client.notes || '';
            
            // Show form
            document.getElementById('client-form').classList.remove('hidden');
        }

        // Update client
        function updateClient() {
            if (!currentEditingClientId) {
                alert('No client selected for editing');
                return;
            }

            const name = document.getElementById('name').value.trim();
            const joinDate = document.getElementById('join-date').value;
            const accountManager = document.getElementById('account-manager').value.trim();
            const nps = parseFloat(document.getElementById('nps').value) || 7;
            const sessionShowUp = parseInt(document.getElementById('showup').value) || 85;
            const messageResponseTime = parseFloat(document.getElementById('response').value) || 2;
            const participationLevel = parseFloat(document.getElementById('participation').value) || 7;
            const sessionScheduled = document.getElementById('scheduled').value === 'true';
            const surveyFilled = document.getElementById('survey').value === 'true';
            const notes = document.getElementById('notes').value.trim();

            if (!name) {
                alert('Please enter a client name');
                return;
            }

            if (!joinDate) {
                alert('Please select a join date');
                return;
            }

            // Find the existing client
            const existingClient = clients.find(c => c.id === currentEditingClientId);
            if (!existingClient) {
                alert('Client not found');
                return;
            }

            // Calculate new health score
            const tempClient = {
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled
            };
            const newScore = calculateHealthScore(tempClient);

            // Create updated client object
            const updatedClient = {
                ...existingClient,
                name: name,
                joinDate: joinDate,
                accountManager: accountManager,
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled,
                notes: notes,
                updatedAt: new Date().toISOString()
            };

            // Add timeline entry for the update
            if (!updatedClient.timeline) {
                updatedClient.timeline = [];
            }
            
            updatedClient.timeline.push({
                date: new Date().toISOString().split('T')[0],
                event: "Client Data Updated",
                score: newScore,
                type: "update"
            });

            // Update in Firebase
            clientsRef.child(currentEditingClientId).set(updatedClient);

            // Close form and reset
            cancelForm();
            
            alert('Client updated successfully!');
        }

        // Add client
        function addClient() {
            const name = document.getElementById('name').value.trim();
            const joinDate = document.getElementById('join-date').value;
            const accountManager = document.getElementById('account-manager').value.trim();
            const nps = parseFloat(document.getElementById('nps').value) || 7;
            const sessionShowUp = parseInt(document.getElementById('showup').value) || 85;
            const messageResponseTime = parseFloat(document.getElementById('response').value) || 2;
            const participationLevel = parseFloat(document.getElementById('participation').value) || 7;
            const sessionScheduled = document.getElementById('scheduled').value === 'true';
            const surveyFilled = document.getElementById('survey').value === 'true';
            const notes = document.getElementById('notes').value.trim();

            if (!name) {
                alert('Please enter a client name');
                return;
            }

            if (!joinDate) {
                alert('Please select a join date');
                return;
            }

            const tempClient = {
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled
            };
            const currentScore = calculateHealthScore(tempClient);

            const newClient = {
                id: Date.now().toString(),
                name: name,
                joinDate: joinDate,
                accountManager: accountManager,
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled,
                notes: notes,
                isOffboarded: false,
                timeline: [
                    { 
                        date: joinDate, 
                        event: "Client Onboarded", 
                        score: currentScore, 
                        type: "milestone" 
                    }
                ],
                createdAt: new Date().toISOString()
            };

            // Save to Firebase
            clientsRef.child(newClient.id).set(newClient);

            // Clear form
            document.getElementById('name').value = '';
            document.getElementById('join-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('account-manager').value = '';
            document.getElementById('nps').value = '7';
            document.getElementById('showup').value = '85';
            document.getElementById('response').value = '2';
            document.getElementById('participation').value = '7';
            document.getElementById('scheduled').value = 'true';
            document.getElementById('survey').value = 'true';
            document.getElementById('notes').value = '';

            toggleForm();
        }

        // Delete client
        function deleteClient(id) {
            const client = clients.find(c => c.id === id);
            const clientName = client ? client.name : 'this client';
            
            if (confirm(`Are you sure you want to permanently delete ${clientName}? This action cannot be undone.`)) {
                clientsRef.child(id).remove();
            }
        }

        // Update sync indicator
        function updateSyncIndicator(isConnected) {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            
            if (isConnected) {
                dot.classList.remove('offline');
                status.textContent = 'Connected';
            } else {
                dot.classList.add('offline');
                status.textContent = 'Offline';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('offboard-modal');
            if (event.target === modal) {
                closeOffboardModal();
            }
        }

        // Initialize Firebase listeners
        clientsRef.on('value', (snapshot) => {
            clients = [];
            snapshot.forEach((childSnapshot) => {
                clients.push(childSnapshot.val());
            });
            updateDashboard();
        });

        // Monitor connection state
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
            updateSyncIndicator(snapshot.val() === true);
        });

        // Initialize with sample data if database is empty
        clientsRef.once('value', (snapshot) => {
            if (!snapshot.exists()) {
                const sampleClients = [
                    {
                        id: '1',
                        name: "Acme Corp",
                        joinDate: "2023-01-15",
                        accountManager: "Sarah Johnson",
                        nps: 9,
                        sessionShowUp: 95,
                        messageResponseTime: 1,
                        sessionScheduled: true,
                        participationLevel: 8.5,
                        surveyFilled: true,
                        notes: "Very engaged client, always provides valuable feedback. CEO is particularly interested in new features.",
                        isOffboarded: false,
                        timeline: [
                            { date: "2023-01-15", event: "Client Onboarded", score: 7.5, type: "milestone" },
                            { date: "2023-03-20", event: "First Health Check", score: 8.0, type: "assessment" },
                            { date: "2023-06-10", event: "Quarterly Review", score: 8.3, type: "review" },
                            { date: "2023-09-15", event: "Contract Renewal", score: 8.7, type: "milestone" },
                            { date: "2024-01-20", event: "Annual Review", score: 9.0, type: "review" },
                            { date: "2024-12-01", event: "Current Status", score: 9.0, type: "current" }
                        ]
                    },
                    {
                        id: '2',
                        name: "TechStart Inc",
                        joinDate: "2023-06-01",
                        accountManager: "Mike Chen",
                        nps: 7,
                        sessionShowUp: 75,
                        messageResponseTime: 2.5,
                        sessionScheduled: false,
                        participationLevel: 6,
                        surveyFilled: true,
                        notes: "Growing startup, sometimes struggles with scheduling. Team is very technical but needs more guidance on implementation.",
                        isOffboarded: false,
                        timeline: [
                            { date: "2023-06-01", event: "Client Onboarded", score: 8.2, type: "milestone" },
                            { date: "2023-08-15", event: "First Health Check", score: 7.8, type: "assessment" },
                            { date: "2023-11-30", event: "Quarterly Review", score: 7.5, type: "review" },
                            { date: "2024-03-10", event: "Support Escalation", score: 7.2, type: "incident" },
                            { date: "2024-06-01", event: "Contract Renewal", score: 7.1, type: "milestone" },
                            { date: "2024-12-01", event: "Current Status", score: 7.1, type: "current" }
                        ]
                    },
                    {
                        id: '3',
                        name: "Global Solutions",
                        joinDate: "2024-02-10",
                        accountManager: "Jennifer Rodriguez",
                        nps: 4,
                        sessionShowUp: 45,
                        messageResponseTime: 5,
                        sessionScheduled: false,
                        participationLevel: 3,
                        surveyFilled: false,
                        notes: "Struggling with adoption. Multiple stakeholders with different priorities. Requires immediate intervention and dedicated support.",
                        isOffboarded: false,
                        timeline: [
                            { date: "2024-02-10", event: "Client Onboarded", score: 6.8, type: "milestone" },
                            { date: "2024-04-15", event: "First Health Check", score: 6.2, type: "assessment" },
                            { date: "2024-07-20", event: "Quarterly Review", score: 5.5, type: "review" },
                            { date: "2024-09-30", event: "Escalation Required", score: 4.8, type: "incident" },
                            { date: "2024-12-01", event: "Critical Status", score: 4.2, type: "current" }
                        ]
                    },
                    {
                        id: '4',
                        name: "Legacy Corp",
                        joinDate: "2022-03-01",
                        accountManager: "David Park",
                        nps: 6,
                        sessionShowUp: 60,
                        messageResponseTime: 4,
                        sessionScheduled: true,
                        participationLevel: 5,
                        surveyFilled: false,
                        notes: "Large enterprise client with complex requirements. Decision-making process was slow. Opted for competitor solution due to pricing concerns.",
                        isOffboarded: true,
                        offboardDate: "2024-11-15",
                        timeline: [
                            { date: "2022-03-01", event: "Client Onboarded", score: 7.8, type: "milestone" },
                            { date: "2022-09-15", event: "First Health Check", score: 7.2, type: "assessment" },
                            { date: "2023-03-01", event: "Annual Review", score: 6.8, type: "review" },
                            { date: "2024-01-10", event: "Support Issues", score: 6.2, type: "incident" },
                            { date: "2024-11-15", event: "Client Offboarded", score: 6.0, type: "offboard" }
                        ]
                    }
                ];

                // Save sample data to Firebase
                sampleClients.forEach(client => {
                    clientsRef.child(client.id).set(client);
                });
            }
        });
    </script>
</body>
</html>
