<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Retention Dashboard - Real-time Sync</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .sync-dot.offline {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 24px;
        }
        
        .stat-icon.blue { background-color: #dbeafe; color: #2563eb; }
        .stat-icon.green { background-color: #dcfce7; color: #16a34a; }
        .stat-icon.yellow { background-color: #fef3c7; color: #d97706; }
        .stat-icon.red { background-color: #fee2e2; color: #dc2626; }
        
        .stat-info h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .stat-info p {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn:hover {
            background-color: #1d4ed8;
        }
        
        .btn-success {
            background-color: #16a34a;
        }
        
        .btn-success:hover {
            background-color: #15803d;
        }
        
        .btn-secondary {
            background-color: #6b7280;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .form-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .form-group input, .form-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .table-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-badge.healthy {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-badge.at-risk {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.critical {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .details {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        
        .alerts-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .alerts-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }
        
        .alerts-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .alert-urgent {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 12px;
            animation: pulse 2s infinite;
        }
        
        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .alert-item {
            padding: 16px;
            border-radius: 6px;
            border: 1px solid;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        
        .alert-item.critical {
            background-color: #fef2f2;
            border-color: #fecaca;
        }
        
        .alert-item.warning {
            background-color: #fffbeb;
            border-color: #fed7aa;
        }
        
        .alert-item.info {
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-content h4 {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .alert-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dismiss-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .bar-chart {
            display: flex;
            align-items: end;
            height: 200px;
            gap: 12px;
            padding: 20px 0;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, #e5e7eb, #3b82f6);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 20px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            padding-bottom: 8px;
        }
        
        .bar.healthy {
            background: linear-gradient(to top, #dcfce7, #16a34a);
        }
        
        .bar.at-risk {
            background: linear-gradient(to top, #fef3c7, #d97706);
        }
        
        .bar.critical {
            background: linear-gradient(to top, #fee2e2, #dc2626);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
            width: 100%;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .legend-color.healthy { background-color: #16a34a; }
        .legend-color.at-risk { background-color: #d97706; }
        .legend-color.critical { background-color: #dc2626; }
        
        .time-filter-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .time-filter-header {
            margin-bottom: 20px;
        }
        
        .time-filter-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #111827;
        }
        
        .time-filter-header p {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .time-filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background-color: #f9fafb;
            border-radius: 6px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
            background-color: white;
        }
        
        .time-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 6px;
            text-align: center;
        }
        
        .insight-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .insight-card:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .insight-card:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .insight-card h4 {
            font-size: 0.875rem;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .insight-card p {
            font-size: 0.875rem;
            margin: 0;
        }
        
        .insight-card strong {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .timeline-view {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .timeline-container {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-line {
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #10b981, #f59e0b, #ef4444);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 24px;
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            margin-left: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid white;
            box-shadow: 0 0 0 3px #10b981;
        }
        
        .timeline-item.warning::before {
            background: #f59e0b;
            box-shadow: 0 0 0 3px #f59e0b;
        }
        
        .timeline-item.critical::before {
            background: #ef4444;
            box-shadow: 0 0 0 3px #ef4444;
        }
        
        .timeline-date {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .timeline-content h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .hidden {
            display: none;
        }

        .join-date {
            font-size: 0.75rem;
            color: #059669;
            font-weight: 500;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- Sync Indicator -->
    <div class="sync-indicator">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-status">Connected</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Client Retention Dashboard</h1>
            <p>Monitor client health scores and retention metrics</p>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">ðŸ‘¥</div>
                <div class="stat-info">
                    <h3>Total Clients</h3>
                    <p id="total-clients">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">âœ“</div>
                <div class="stat-info">
                    <h3>Healthy</h3>
                    <p id="healthy-clients" style="color: #16a34a;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow">âš </div>
                <div class="stat-info">
                    <h3>At Risk</h3>
                    <p id="at-risk-clients" style="color: #d97706;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">ðŸ“‰</div>
                <div class="stat-info">
                    <h3>Critical</h3>
                    <p id="critical-clients" style="color: #dc2626;">0</p>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section" id="alerts-section">
            <div class="alerts-header">
                <span style="font-size: 24px;">ðŸ””</span>
                <h2>Active Alerts (<span id="alert-count">0</span>)</h2>
                <span class="alert-urgent" id="urgent-badge" style="display: none;">0 Urgent</span>
            </div>
            <div class="alerts-grid" id="alerts-container">
                <!-- Alerts will be inserted here -->
            </div>
        </div>

        <!-- Time Frame Analysis -->
        <div class="time-filter-section">
            <div class="time-filter-header">
                <h3>ðŸ“… Time Analysis</h3>
                <p>Analyze client health across different time periods</p>
            </div>
            <div class="time-filter-controls">
                <div class="filter-group">
                    <label>Time Period:</label>
                    <select id="time-period" onchange="updateTimeFrame()">
                        <option value="lifetime">Lifetime (All Time)</option>
                        <option value="12months">Last 12 Months</option>
                        <option value="6months">Last 6 Months</option>
                        <option value="3months">Last 3 Months</option>
                        <option value="1month">Last Month</option>
                        <option value="current">Current Period</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>View Type:</label>
                    <select id="view-type" onchange="updateTimeFrame()">
                        <option value="summary">Summary View</option>
                        <option value="timeline">Client Timeline</option>
                        <option value="trends">Trend Analysis</option>
                    </select>
                </div>
            </div>
            <div class="time-insights" id="time-insights">
                <!-- Insights will be populated here -->
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3>Health Score Overview</h3>
                <div class="chart-container" id="score-chart">
                    <!-- Chart will be generated here -->
                </div>
            </div>
            <div class="chart-card">
                <h3>Client Distribution</h3>
                <div class="chart-container" id="distribution-chart">
                    <!-- Chart will be generated here -->
                </div>
            </div>
        </div>

        <!-- Add Client Button -->
        <button class="btn" onclick="toggleForm()">
            âž• Add Client
        </button>

        <!-- Add Client Form -->
        <div class="form-section hidden" id="client-form">
            <h3 style="margin-bottom: 16px;">Add New Client</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="name" placeholder="Enter client name">
                </div>
                <div class="form-group">
                    <label>Join Date</label>
                    <input type="date" id="join-date" value="">
                </div>
                <div class="form-group">
                    <label>NPS Score (0-10)</label>
                    <input type="number" id="nps" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Session Show Up (%)</label>
                    <input type="number" id="showup" min="0" max="100" value="85">
                </div>
                <div class="form-group">
                    <label>Response Time (days)</label>
                    <input type="number" id="response" min="0" step="0.1" value="2">
                </div>
                <div class="form-group">
                    <label>Participation Level (0-10)</label>
                    <input type="number" id="participation" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Session Scheduled</label>
                    <select id="scheduled">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Survey Filled</label>
                    <select id="survey">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
            </div>
            <div>
                <button class="btn btn-success" onclick="addClient()">Add Client</button>
                <button class="btn btn-secondary" onclick="toggleForm()">Cancel</button>
            </div>
        </div>

        <!-- Client Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>Client Health Scores</h2>
            </div>
            <div>
                <table>
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Join Date</th>
                            <th>NPS</th>
                            <th>Engagement</th>
                            <th>Health Score</th>
                            <th>Status</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-table">
                        <!-- Clients will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDNMzO17wu4NOaR2TjT419f0IzB-pWzU5M",
            authDomain: "becontent-33415.firebaseapp.com",
            databaseURL: "https://becontent-33415-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "becontent-33415",
            storageBucket: "becontent-33415.firebasestorage.app",
            messagingSenderId: "967557303388",
            appId: "1:967557303388:web:b263a25fea91824710ea99",
            measurementId: "G-Z23YF3S7VQ"
        };

        // Initialize Firebase
        let database;
        let clientsRef;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            clientsRef = database.ref('clients');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Local clients array
        let clients = [];
        let dismissedAlerts = new Set();

        // Set default join date to today when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('join-date').value = today;
        });

        // Calculate engagement score
        function calculateEngagementScore(client) {
            const sessionScore = client.sessionShowUp >= 90 ? 10 : client.sessionShowUp >= 60 ? 7.5 : 3;
            const responseScore = client.messageResponseTime <= 2 ? 10 : client.messageResponseTime <= 3 ? 7.5 : 3;
            const scheduleScore = client.sessionScheduled ? 10 : 3;
            const participationScore = client.participationLevel;
            const surveyScore = client.surveyFilled ? 10 : 3;

            return (sessionScore * 0.4) + (responseScore * 0.1) + (scheduleScore * 0.05) + (participationScore * 0.35) + (surveyScore * 0.1);
        }

        // Calculate health score
        function calculateHealthScore(client) {
            const npsScore = client.nps;
            const engagementScore = calculateEngagementScore(client);
            return (npsScore * 0.6) + (engagementScore * 0.4);
        }

        // Get health category
        function getHealthCategory(score) {
            if (score >= 8) return { color: 'healthy', label: 'Healthy' };
            if (score >= 7) return { color: 'at-risk', label: 'At Risk' };
            return { color: 'critical', label: 'Critical' };
        }

        // Time frame analysis functions
        function updateTimeFrame() {
            const period = document.getElementById('time-period').value;
            const viewType = document.getElementById('view-type').value;
            
            updateTimeInsights(period);
            updateTimelineView(viewType, period);
        }

        function updateTimeInsights(period) {
            const insights = calculateTimeInsights(period);
            const insightsContainer = document.getElementById('time-insights');
            
            insightsContainer.innerHTML = `
                <div class="insight-card">
                    <h4>ðŸ“ˆ Average Relationship</h4>
                    <p>${insights.avgRelationship}</p>
                </div>
                <div class="insight-card">
                    <h4>ðŸŽ¯ Retention Rate</h4>
                    <p>${insights.retentionRate}</p>
                </div>
                <div class="insight-card">
                    <h4>âš¡ Health Trend</h4>
                    <p>${insights.healthTrend}</p>
                </div>
                <div class="insight-card">
                    <h4>ðŸš¨ Risk Analysis</h4>
                    <p>${insights.riskAnalysis}</p>
                </div>`;
        }

        function calculateTimeInsights(period) {
            let totalMonths = 0;
            const healthChanges = [];
            let retainedClients = 0;
            
            clients.forEach(client => {
                if (client.joinDate) {
                    const joinDate = new Date(client.joinDate);
                    const currentDate = new Date();
                    const monthsDiff = (currentDate - joinDate) / (1000 * 60 * 60 * 24 * 30);
                    totalMonths += monthsDiff;
                }
                
                if (client.timeline && client.timeline.length > 1) {
                    const firstScore = client.timeline[0].score;
                    const lastScore = client.timeline[client.timeline.length - 1].score;
                    healthChanges.push(lastScore - firstScore);
                }
                
                if (calculateHealthScore(client) >= 7) {
                    retainedClients++;
                }
            });
            
            const avgRelationship = clients.length > 0 ? (totalMonths / clients.length).toFixed(1) : 0;
            const retentionRate = clients.length > 0 ? ((retainedClients / clients.length) * 100).toFixed(0) : 0;
            const avgHealthChange = healthChanges.length > 0 ? 
                healthChanges.reduce((a, b) => a + b, 0) / healthChanges.length : 0;
            const trendDirection = avgHealthChange > 0 ? 'Improving' : avgHealthChange < 0 ? 'Declining' : 'Stable';
            
            return {
                avgRelationship: `<strong>${avgRelationship} months</strong>`,
                retentionRate: `<strong>${retentionRate}%</strong> healthy clients`,
                healthTrend: `<strong>${trendDirection} (${avgHealthChange > 0 ? '+' : ''}${avgHealthChange.toFixed(1)})</strong>`,
                riskAnalysis: `<strong>${clients.filter(c => calculateHealthScore(c) < 7).length}</strong> clients at risk`
            };
        }

        function updateTimelineView(viewType, period) {
            // Remove existing timeline
            const existingTimeline = document.querySelector('.timeline-view');
            if (existingTimeline) {
                existingTimeline.remove();
            }
            
            if (viewType === 'timeline' || viewType === 'trends') {
                createTimelineView(viewType, period);
            }
        }

        function createTimelineView(viewType, period) {
            const timelineDiv = document.createElement('div');
            timelineDiv.className = 'timeline-view';
            
            timelineDiv.innerHTML = `
                <div class="timeline-header">
                    <h3>${viewType === 'timeline' ? 'ðŸ“‹ Client Timeline' : 'ðŸ“ˆ Trend Analysis'}</h3>
                    <span style="font-size: 0.875rem; color: #6b7280;">Showing ${period === 'lifetime' ? 'all historical data' : period}</span>
                </div>
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${generateTimelineItems(viewType, period)}
                </div>`;
            
            const chartsSection = document.querySelector('.charts-section');
            chartsSection.parentNode.insertBefore(timelineDiv, chartsSection);
        }

        function generateTimelineItems(viewType, period) {
            const allEvents = [];
            
            clients.forEach(client => {
                if (client.timeline) {
                    client.timeline.forEach(event => {
                        allEvents.push({
                            date: event.date,
                            event: event.event,
                            score: event.score,
                            type: event.type,
                            clientName: client.name,
                            clientId: client.id
                        });
                    });
                }
            });
            
            // Sort by date
            allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Filter by period if not lifetime
            if (period !== 'lifetime') {
                const cutoffDate = new Date();
                switch(period) {
                    case '1month':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 1);
                        break;
                    case '3months':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 3);
                        break;
                    case '6months':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 6);
                        break;
                    case '12months':
                        cutoffDate.setFullYear(cutoffDate.getFullYear() - 1);
                        break;
                }
                allEvents = allEvents.filter(event => new Date(event.date) >= cutoffDate);
            }
            
            let timelineHTML = '';
            allEvents.forEach(event => {
                const eventClass = event.score < 7 ? 'critical' : event.score < 8 ? 'warning' : '';
                const formattedDate = new Date(event.date).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                timelineHTML += `
                    <div class="timeline-item ${eventClass}">
                        <div class="timeline-date">${formattedDate}</div>
                        <div class="timeline-content">
                            <h4>${event.clientName}: ${event.event}</h4>
                            <p>Health Score: ${event.score.toFixed(1)} | Type: ${event.type}</p>
                        </div>
                    </div>`;
            });
            
            return timelineHTML || '<p style="color: #6b7280; padding: 20px;">No timeline data available for this period</p>';
        }

        // Update dashboard
        function updateDashboard() {
            const stats = { total: clients.length, healthy: 0, atRisk: 0, critical: 0 };
            
            clients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score);
                if (category.color === 'healthy') stats.healthy++;
                else if (category.color === 'at-risk') stats.atRisk++;
                else stats.critical++;
            });

            document.getElementById('total-clients').textContent = stats.total;
            document.getElementById('healthy-clients').textContent = stats.healthy;
            document.getElementById('at-risk-clients').textContent = stats.atRisk;
            document.getElementById('critical-clients').textContent = stats.critical;

            updateTable();
            updateAlerts();
            updateCharts();
            updateTimeFrame();
        }

        // Update alerts
        function updateAlerts() {
            const alertsContainer = document.getElementById('alerts-container');
            const alertsSection = document.getElementById('alerts-section');
            alertsContainer.innerHTML = '';
            let alertCount = 0;
            let urgentCount = 0;

            clients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score);

                // Critical alerts
                if (category.color === 'critical' && !dismissedAlerts.has(`critical-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item critical';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Client is in critical status (${score.toFixed(1)})</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('critical-${client.id}', this)">âœ•</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                    urgentCount++;
                }

                // At-risk alerts
                if (category.color === 'at-risk' && !dismissedAlerts.has(`at-risk-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item warning';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Client is at risk (${score.toFixed(1)})</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('at-risk-${client.id}', this)">âœ•</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                // Low attendance alerts
                if (client.sessionShowUp < 60 && !dismissedAlerts.has(`attendance-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item info';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Low session attendance: ${client.sessionShowUp}%</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('attendance-${client.id}', this)">âœ•</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                // Slow response alerts
                if (client.messageResponseTime > 3 && !dismissedAlerts.has(`response-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item info';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Slow response time: ${client.messageResponseTime} days</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('response-${client.id}', this)">âœ•</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }
            });

            document.getElementById('alert-count').textContent = alertCount;
            document.getElementById('urgent-badge').style.display = urgentCount > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentCount + ' Urgent';
            
            // Hide alerts section if no alerts
            alertsSection.style.display = alertCount > 0 ? 'block' : 'none';
        }

        // Dismiss alert
        function dismissAlert(alertId, button) {
            dismissedAlerts.add(alertId);
            button.parentElement.remove();
            const alertCount = document.querySelectorAll('.alert-item').length;
            document.getElementById('alert-count').textContent = alertCount;
            
            const urgentAlerts = document.querySelectorAll('.alert-item.critical').length;
            document.getElementById('urgent-badge').style.display = urgentAlerts > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentAlerts + ' Urgent';
            
            // Hide alerts section if no alerts left
            if (alertCount === 0) {
                document.getElementById('alerts-section').style.display = 'none';
            }
        }

        // Update charts
        function updateCharts() {
            updateScoreChart();
            updateDistributionChart();
        }

        // Update score chart
        function updateScoreChart() {
            const chartContainer = document.getElementById('score-chart');
            chartContainer.innerHTML = '';

            if (clients.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">No clients to display</div>';
                return;
            }

            const barChart = document.createElement('div');
            barChart.className = 'bar-chart';

            clients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score);
                
                const barContainer = document.createElement('div');
                barContainer.style.flex = '1';
                barContainer.style.position = 'relative';
                barContainer.style.height = '100%';
                
                const bar = document.createElement('div');
                bar.className = `bar ${category.color}`;
                bar.style.height = `${(score / 10 * 100)}%`;
                bar.textContent = score.toFixed(1);
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = client.name.length > 10 ? client.name.substring(0, 10) + '...' : client.name;
                
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                barChart.appendChild(barContainer);
            });

            chartContainer.appendChild(barChart);
        }

        // Update distribution chart
        function updateDistributionChart() {
            const chartContainer = document.getElementById('distribution-chart');
            chartContainer.innerHTML = '';

            const stats = { healthy: 0, atRisk: 0, critical: 0 };
            
            clients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score);
                if (category.color === 'healthy') stats.healthy++;
                else if (category.color === 'at-risk') stats.atRisk++;
                else stats.critical++;
            });

            const total = clients.length;
            if (total === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">No clients to display</div>';
                return;
            }

            const healthyPercent = (stats.healthy / total * 100);
            const atRiskPercent = (stats.atRisk / total * 100);
            const criticalPercent = (stats.critical / total * 100);

            // Create pie chart visualization
            const pieContainer = document.createElement('div');
            pieContainer.style.width = '200px';
            pieContainer.style.height = '200px';
            pieContainer.style.margin = '0 auto';
            pieContainer.style.borderRadius = '50%';
            pieContainer.style.background = `conic-gradient(
                #16a34a 0% ${healthyPercent}%, 
                #d97706 ${healthyPercent}% ${healthyPercent + atRiskPercent}%, 
                #dc2626 ${healthyPercent + atRiskPercent}% 100%)`;

            chartContainer.appendChild(pieContainer);

            // Add legend
            const legend = document.createElement('div');
            legend.className = 'chart-legend';
            
            const chartData = [
                { label: 'Healthy', count: stats.healthy, color: '#16a34a' },
                { label: 'At Risk', count: stats.atRisk, color: '#d97706' },
                { label: 'Critical', count: stats.critical, color: '#dc2626' }
            ];

            chartData.forEach(item => {
                if (item.count > 0) {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = item.color;
                    
                    const text = document.createElement('span');
                    text.textContent = `${item.label} (${item.count})`;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(text);
                    legend.appendChild(legendItem);
                }
            });
            
            chartContainer.appendChild(legend);
        }

        // Update table
        function updateTable() {
            const tableBody = document.getElementById('client-table');
            tableBody.innerHTML = '';

            clients.forEach(client => {
                const healthScore = calculateHealthScore(client);
                const engagementScore = calculateEngagementScore(client);
                const category = getHealthCategory(healthScore);

                // Format join date
                const joinDate = client.joinDate ? new Date(client.joinDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : 'N/A';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${client.name}</strong>
                        <div class="join-date">Joined: ${joinDate}</div>
                    </td>
                    <td>${joinDate}</td>
                    <td>${client.nps.toFixed(1)}</td>
                    <td>${engagementScore.toFixed(1)}</td>
                    <td><strong>${healthScore.toFixed(1)}</strong></td>
                    <td><span class="status-badge ${category.color}">${category.label}</span></td>
                    <td class="details">
                        Show Up: ${client.sessionShowUp}%<br>
                        Response: ${client.messageResponseTime}d<br>
                        Scheduled: ${client.sessionScheduled ? 'Yes' : 'No'}<br>
                        Participation: ${client.participationLevel}<br>
                        Survey: ${client.surveyFilled ? 'Yes' : 'No'}
                    </td>
                    <td><button class="delete-btn" onclick="deleteClient('${client.id}')">ðŸ—‘</button></td>`;
                
                tableBody.appendChild(row);
            });
        }

        // Toggle form
        function toggleForm() {
            const form = document.getElementById('client-form');
            form.classList.toggle('hidden');
        }

        // Add client
        function addClient() {
            const name = document.getElementById('name').value.trim();
            const joinDate = document.getElementById('join-date').value;
            const nps = parseFloat(document.getElementById('nps').value) || 7;
            const sessionShowUp = parseInt(document.getElementById('showup').value) || 85;
            const messageResponseTime = parseFloat(document.getElementById('response').value) || 2;
            const participationLevel = parseFloat(document.getElementById('participation').value) || 7;
            const sessionScheduled = document.getElementById('scheduled').value === 'true';
            const surveyFilled = document.getElementById('survey').value === 'true';

            if (!name) {
                alert('Please enter a client name');
                return;
            }

            if (!joinDate) {
                alert('Please select a join date');
                return;
            }

            const tempClient = {
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled
            };
            const currentScore = calculateHealthScore(tempClient);

            const newClient = {
                id: Date.now().toString(),
                name: name,
                joinDate: joinDate,
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled,
                timeline: [
                    { 
                        date: joinDate, 
                        event: "Client Onboarded", 
                        score: currentScore, 
                        type: "milestone" 
                    }
                ],
                createdAt: new Date().toISOString()
            };

            // Save to Firebase
            clientsRef.child(newClient.id).set(newClient);

            // Clear form
            document.getElementById('name').value = '';
            document.getElementById('join-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('nps').value = '7';
            document.getElementById('showup').value = '85';
            document.getElementById('response').value = '2';
            document.getElementById('participation').value = '7';
            document.getElementById('scheduled').value = 'true';
            document.getElementById('survey').value = 'true';

            toggleForm();
        }

        // Delete client
        function deleteClient(id) {
            if (confirm('Are you sure you want to delete this client?')) {
                clientsRef.child(id).remove();
            }
        }

        // Update sync indicator
        function updateSyncIndicator(isConnected) {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            
            if (isConnected) {
                dot.classList.remove('offline');
                status.textContent = 'Connected';
            } else {
                dot.classList.add('offline');
                status.textContent = 'Offline';
            }
        }

        // Initialize Firebase listeners
        clientsRef.on('value', (snapshot) => {
            clients = [];
            snapshot.forEach((childSnapshot) => {
                clients.push(childSnapshot.val());
            });
            updateDashboard();
        });

        // Monitor connection state
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
            updateSyncIndicator(snapshot.val() === true);
        });

        // Initialize with sample data if database is empty
        clientsRef.once('value', (snapshot) => {
            if (!snapshot.exists()) {
                const sampleClients = [
                    {
                        id: '1',
                        name: "Acme Corp",
                        joinDate: "2023-01-15",
                        nps: 9,
                        sessionShowUp: 95,
                        messageResponseTime: 1,
                        sessionScheduled: true,
                        participationLevel: 8.5,
                        surveyFilled: true,
                        timeline: [
                            { date: "2023-01-15", event: "Client Onboarded", score: 7.5, type: "milestone" },
                            { date: "2023-03-20", event: "First Health Check", score: 8.0, type: "assessment" },
                            { date: "2023-06-10", event: "Quarterly Review", score: 8.3, type: "review" },
                            { date: "2023-09-15", event: "Contract Renewal", score: 8.7, type: "milestone" },
                            { date: "2024-01-20", event: "Annual Review", score: 9.0, type: "review" },
                            { date: "2024-12-01", event: "Current Status", score: 9.0, type: "current" }
                        ]
                    },
                    {
                        id: '2',
                        name: "TechStart Inc",
                        joinDate: "2023-06-01",
                        nps: 7,
                        sessionShowUp: 75,
                        messageResponseTime: 2.5,
                        sessionScheduled: false,
                        participationLevel: 6,
                        surveyFilled: true,
                        timeline: [
                            { date: "2023-06-01", event: "Client Onboarded", score: 8.2, type: "milestone" },
                            { date: "2023-08-15", event: "First Health Check", score: 7.8, type: "assessment" },
                            { date: "2023-11-30", event: "Quarterly Review", score: 7.5, type: "review" },
                            { date: "2024-03-10", event: "Support Escalation", score: 7.2, type: "incident" },
                            { date: "2024-06-01", event: "Contract Renewal", score: 7.1, type: "milestone" },
                            { date: "2024-12-01", event: "Current Status", score: 7.1, type: "current" }
                        ]
                    },
                    {
                        id: '3',
                        name: "Global Solutions",
                        joinDate: "2024-02-10",
                        nps: 4,
                        sessionShowUp: 45,
                        messageResponseTime: 5,
                        sessionScheduled: false,
                        participationLevel: 3,
                        surveyFilled: false,
                        timeline: [
                            { date: "2024-02-10", event: "Client Onboarded", score: 6.8, type: "milestone" },
                            { date: "2024-04-15", event: "First Health Check", score: 6.2, type: "assessment" },
                            { date: "2024-07-20", event: "Quarterly Review", score: 5.5, type: "review" },
                            { date: "2024-09-30", event: "Escalation Required", score: 4.8, type: "incident" },
                            { date: "2024-12-01", event: "Critical Status", score: 4.2, type: "current" }
                        ]
                    }
                ];

                // Save sample data to Firebase
                sampleClients.forEach(client => {
                    clientsRef.child(client.id).set(client);
                });
            }
        });
    </script>
</body>
</html>
