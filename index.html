<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeContent Client Retention Dashboard</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .sync-dot.offline {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 24px;
        }
        
        .stat-icon.blue { background-color: #dbeafe; color: #2563eb; }
        .stat-icon.green { background-color: #dcfce7; color: #16a34a; }
        .stat-icon.yellow { background-color: #fef3c7; color: #d97706; }
        .stat-icon.red { background-color: #fee2e2; color: #dc2626; }
        .stat-icon.purple { background-color: #ede9fe; color: #7c3aed; }
        
        .stat-info h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .stat-info p {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn:hover {
            background-color: #1d4ed8;
        }
        
        .btn-success {
            background-color: #16a34a;
        }
        
        .btn-success:hover {
            background-color: #15803d;
        }
        
        .btn-secondary {
            background-color: #6b7280;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-warning {
            background-color: #f59e0b;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
        }
        
        .form-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .table-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .client-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .client-filter select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        tr.offboarded {
            background-color: #fef2f2;
            opacity: 0.8;
        }
        
        tr.offboarded:hover {
            background-color: #fee2e2;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-badge.healthy {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-badge.at-risk {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.critical {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-badge.offboarded {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        
        .month-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .offboard-date {
            font-size: 0.75rem;
            color: #dc2626;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .details {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .account-manager {
            font-size: 0.875rem;
            color: #2563eb;
            font-weight: 500;
        }
        
        .notes {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .notes:empty::before {
            content: "No notes";
            color: #9ca3af;
            font-style: italic;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin: 0 2px;
        }
        
        .edit-btn {
            color: #2563eb;
        }
        
        .edit-btn:hover {
            background-color: #dbeafe;
        }
        
        .delete-btn {
            color: #dc2626;
        }
        
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        
        .offboard-btn {
            color: #f59e0b;
        }
        
        .offboard-btn:hover {
            background-color: #fef3c7;
        }
        
        .reactivate-btn {
            color: #16a34a;
        }
        
        .reactivate-btn:hover {
            background-color: #dcfce7;
        }
        
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .alerts-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .alerts-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }
        
        .alerts-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .alert-urgent {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 12px;
            animation: pulse 2s infinite;
        }
        
        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .alert-item {
            padding: 16px;
            border-radius: 6px;
            border: 1px solid;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        
        .alert-item.critical {
            background-color: #fef2f2;
            border-color: #fecaca;
        }
        
        .alert-item.warning {
            background-color: #fffbeb;
            border-color: #fed7aa;
        }
        
        .alert-item.info {
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-content h4 {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .alert-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dismiss-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .bar-chart {
            display: flex;
            align-items: end;
            height: 200px;
            gap: 12px;
            padding: 20px 0;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, #e5e7eb, #3b82f6);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 20px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            padding-bottom: 8px;
        }
        
        .bar.healthy {
            background: linear-gradient(to top, #dcfce7, #16a34a);
        }
        
        .bar.at-risk {
            background: linear-gradient(to top, #fef3c7, #d97706);
        }
        
        .bar.critical {
            background: linear-gradient(to top, #fee2e2, #dc2626);
        }
        
        .bar.offboarded {
            background: linear-gradient(to top, #f3f4f6, #6b7280);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
            width: 100%;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .legend-color.healthy { background-color: #16a34a; }
        .legend-color.at-risk { background-color: #d97706; }
        .legend-color.critical { background-color: #dc2626; }
        .legend-color.offboarded { background-color: #6b7280; }
        
        .account-manager-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .section-header {
            margin-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 16px;
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .section-header p {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .manager-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .manager-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .manager-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        
        .manager-card.no-manager {
            background: linear-gradient(135deg, #fef7f0 0%, #fef3e2 100%);
            border-color: #fed7aa;
        }
        
        .manager-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .manager-card.no-manager::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .manager-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .manager-info h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .manager-info .client-count {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .manager-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .manager-avatar.no-manager {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .manager-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .metric-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .metric-value.health-score {
            color: #059669;
        }
        
        .metric-value.retention-rate {
            color: #3b82f6;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .client-distribution {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .distribution-item {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .distribution-item.healthy {
            background: #dcfce7;
            color: #166534;
        }
        
        .distribution-item.at-risk {
            background: #fef3c7;
            color: #92400e;
        }
        
        .distribution-item.critical {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .distribution-item.offboarded {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .manager-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-link {
            flex: 1;
            padding: 8px 12px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s;
        }
        
        .action-link:hover {
            background: #1d4ed8;
            color: white;
        }
        
        .action-link.secondary {
            background: #6b7280;
        }
        
        .action-link.secondary:hover {
            background: #4b5563;
        }
        
        .no-managers-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .hidden {
            display: none;
        }

        .join-date {
            font-size: 0.75rem;
            color: #059669;
            font-weight: 500;
            margin-top: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal h3 {
            margin-bottom: 16px;
            color: #111827;
        }

        .modal p {
            margin-bottom: 20px;
            color: #6b7280;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="sync-indicator">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-status">Connected</span>
    </div>

    <div id="offboard-modal" class="modal">
        <div class="modal-content">
            <h3>Offboard Client</h3>
            <p>Are you sure you want to offboard <strong id="offboard-client-name"></strong>? This will mark them as inactive but preserve all their data.</p>
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Offboard Date:</label>
                <input type="date" id="offboard-date" style="width: 100%;">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeOffboardModal()">Cancel</button>
                <button class="btn btn-warning" onclick="confirmOffboard()">Offboard Client</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>BeContent Client Retention Dashboard</h1>
            <p>Monitor client health scores and retention metrics</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">üë•</div>
                <div class="stat-info">
                    <h3>Total Clients</h3>
                    <p id="total-clients">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">‚úì</div>
                <div class="stat-info">
                    <h3>Active & Healthy</h3>
                    <p id="healthy-clients" style="color: #16a34a;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow">‚ö†</div>
                <div class="stat-info">
                    <h3>At Risk</h3>
                    <p id="at-risk-clients" style="color: #d97706;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">üìâ</div>
                <div class="stat-info">
                    <h3>Critical</h3>
                    <p id="critical-clients" style="color: #dc2626;">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">üèÉ‚Äç‚ôÇÔ∏è</div>
                <div class="stat-info">
                    <h3>Offboarded</h3>
                    <p id="offboarded-clients" style="color: #7c3aed;">0</p>
                </div>
            </div>
        </div>

        <div class="alerts-section" id="alerts-section">
            <div class="alerts-header">
                <span style="font-size: 24px;">üîî</span>
                <h2>Active Alerts (<span id="alert-count">0</span>)</h2>
                <span class="alert-urgent" id="urgent-badge" style="display: none;">0 Urgent</span>
            </div>
            <div class="alerts-grid" id="alerts-container">
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <h3>Health Score Overview</h3>
                <div class="chart-container" id="score-chart">
                </div>
            </div>
            <div class="chart-card">
                <h3>Client Distribution</h3>
                <div class="chart-container" id="distribution-chart">
                </div>
            </div>
        </div>

        <button class="btn" onclick="toggleForm()">
            ‚ûï Add Client
        </button>

        <div class="form-section hidden" id="client-form">
            <h3 style="margin-bottom: 16px;" id="form-title">Add New Client</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Client Name *</label>
                    <input type="text" id="name" placeholder="Enter client name">
                </div>
                <div class="form-group">
                    <label>Join Date *</label>
                    <input type="date" id="join-date" value="">
                </div>
                <div class="form-group">
                    <label>Account Manager</label>
                    <input type="text" id="account-manager" placeholder="Enter account manager name">
                </div>
                <div class="form-group">
                    <label>NPS Score (0-10) - 30% weight</label>
                    <input type="number" id="nps" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Show Up Rate (%) - 10% weight</label>
                    <input type="number" id="showup" min="0" max="100" value="85">
                </div>
                <div class="form-group">
                    <label>Participation Level (0-10) - 10% weight</label>
                    <input type="number" id="participation" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Payment Status - 10% weight</label>
                    <select id="payment-status">
                        <option value="true">On Time</option>
                        <option value="false">Late</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Video Went Viral? - 20% weight</label>
                    <select id="video-viral">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Early Signs Feedback - 20% weight</label>
                    <select id="early-signs">
                        <option value="true">Positive</option>
                        <option value="false">Negative</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Notes</label>
                    <textarea id="notes" placeholder="Enter any notes about this client"></textarea>
                </div>
            </div>
            <div>
                <button class="btn btn-success" id="submit-btn" onclick="addClient()">Add Client</button>
                <button class="btn btn-secondary" onclick="cancelForm()">Cancel</button>
            </div>
        </div>

        <div class="account-manager-section">
            <div class="section-header">
                <h2>Account Manager Performance</h2>
                <p>Track performance metrics and client health scores by account manager</p>
            </div>
            <div class="manager-cards-grid" id="manager-cards-grid">
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h2>Client Health Scores</h2>
                <div class="client-filter">
                    <label>Filter:</label>
                    <select id="client-status-filter" onchange="updateTable()">
                        <option value="all">All Clients</option>
                        <option value="active">Active Only</option>
                        <option value="offboarded">Offboarded Only</option>
                    </select>
                    <select id="manager-filter" onchange="updateTable()" style="margin-left: 10px;">
                        <option value="all">All Managers</option>
                    </select>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Month</th>
                            <th>Account Manager</th>
                            <th>NPS (30%)</th>
                            <th>Show Up (10%)</th>
                            <th>Participation (10%)</th>
                            <th>Payment (10%)</th>
                            <th>Viral Video (20%)</th>
                            <th>Early Signs (20%)</th>
                            <th>Health Score</th>
                            <th>Status</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-table">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDNMzO17wu4NOaR2TjT419f0IzB-pWzU5M",
            authDomain: "becontent-33415.firebaseapp.com",
            databaseURL: "https://becontent-33415-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "becontent-33415",
            storageBucket: "becontent-33415.firebasestorage.app",
            messagingSenderId: "967557303388",
            appId: "1:967557303388:web:b263a25fea91824710ea99",
            measurementId: "G-Z23YF3S7VQ"
        };

        let database;
        let clientsRef;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            clientsRef = database.ref('clients');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        let clients = [];
        let dismissedAlerts = new Set();
        let currentEditingClientId = null;
        let currentOffboardingClientId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('join-date').value = today;
            document.getElementById('offboard-date').value = today;
        });

        function calculateClientMonth(joinDate, offboardDate = null) {
            if (!joinDate) return 0;
            
            const join = new Date(joinDate);
            const endDate = offboardDate ? new Date(offboardDate) : new Date();
            
            let months = (endDate.getFullYear() - join.getFullYear()) * 12;
            months += endDate.getMonth() - join.getMonth();
            
            if (endDate.getDate() < join.getDate()) {
                months--;
            }
            
            return Math.max(1, months + 1);
        }

        // NEW HEALTH SCORE CALCULATION
        // NPS: 30%, Show Up Rate: 10%, Participation Level: 10%, Payment Status: 10%, 
        // Video Went Viral: 20%, Early Signs Question: 20%
        function calculateHealthScore(client) {
            // NPS Score (0-10) - 30% weight
            const npsScore = (client.nps / 10) * 30;
            
            // Show Up Rate (0-100%) - 10% weight
            const showUpScore = (client.sessionShowUp / 100) * 10;
            
            // Participation Level (0-10) - 10% weight
            const participationScore = (client.participationLevel / 10) * 10;
            
            // Payment Status - 10% weight
            const paymentScore = client.paymentOnTime ? 10 : 0;
            
            // Video Went Viral - 20% weight
            const viralScore = client.videoWentViral ? 20 : 0;
            
            // Early Signs Question - 20% weight
            const earlySignsScore = client.earlySigns ? 20 : 0;
            
            // Total score out of 100, then convert to 0-10 scale
            const totalScore = npsScore + showUpScore + participationScore + paymentScore + viralScore + earlySignsScore;
            
            return totalScore / 10; // Convert from 0-100 to 0-10
        }

        function getHealthCategory(score, isOffboarded = false) {
            if (isOffboarded) return { color: 'offboarded', label: 'Offboarded' };
            if (score >= 8) return { color: 'healthy', label: 'Healthy' };
            if (score >= 7) return { color: 'at-risk', label: 'At Risk' };
            return { color: 'critical', label: 'Critical' };
        }

        function openOffboardModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            currentOffboardingClientId = clientId;
            document.getElementById('offboard-client-name').textContent = client.name;
            document.getElementById('offboard-modal').style.display = 'block';
        }

        function closeOffboardModal() {
            document.getElementById('offboard-modal').style.display = 'none';
            currentOffboardingClientId = null;
        }

        function confirmOffboard() {
            if (!currentOffboardingClientId) return;

            const offboardDate = document.getElementById('offboard-date').value;
            if (!offboardDate) {
                alert('Please select an offboard date');
                return;
            }

            const client = clients.find(c => c.id === currentOffboardingClientId);
            if (!client) return;

            const updatedClient = {
                ...client,
                isOffboarded: true,
                offboardDate: offboardDate,
                updatedAt: new Date().toISOString()
            };

            if (!updatedClient.timeline) {
                updatedClient.timeline = [];
            }
            
            updatedClient.timeline.push({
                date: offboardDate,
                event: "Client Offboarded",
                score: calculateHealthScore(client),
                type: "offboard"
            });

            clientsRef.child(currentOffboardingClientId).set(updatedClient);

            closeOffboardModal();
            alert('Client offboarded successfully!');
        }

        function reactivateClient(clientId) {
            if (!confirm('Are you sure you want to reactivate this client?')) return;

            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const updatedClient = {
                ...client,
                isOffboarded: false,
                reactivateDate: new Date().toISOString().split('T')[0],
                updatedAt: new Date().toISOString()
            };

            delete updatedClient.offboardDate;

            if (!updatedClient.timeline) {
                updatedClient.timeline = [];
            }
            
            updatedClient.timeline.push({
                date: new Date().toISOString().split('T')[0],
                event: "Client Reactivated",
                score: calculateHealthScore(client),
                type: "reactivate"
            });

            clientsRef.child(clientId).set(updatedClient);

            alert('Client reactivated successfully!');
        }

        function updateDashboard() {
            const stats = { 
                total: clients.length, 
                healthy: 0, 
                atRisk: 0, 
                critical: 0, 
                offboarded: 0 
            };
            
            clients.forEach(client => {
                if (client.isOffboarded) {
                    stats.offboarded++;
                } else {
                    const score = calculateHealthScore(client);
                    const category = getHealthCategory(score);
                    if (category.color === 'healthy') stats.healthy++;
                    else if (category.color === 'at-risk') stats.atRisk++;
                    else stats.critical++;
                }
            });

            document.getElementById('total-clients').textContent = stats.total;
            document.getElementById('healthy-clients').textContent = stats.healthy;
            document.getElementById('at-risk-clients').textContent = stats.atRisk;
            document.getElementById('critical-clients').textContent = stats.critical;
            document.getElementById('offboarded-clients').textContent = stats.offboarded;

            updateManagerPerformance();
            updateTable();
            updateAlerts();
            updateCharts();
        }

        function calculateManagerMetrics(managerName) {
            const managerClients = clients.filter(client => {
                if (managerName === 'Unassigned') {
                    return !client.accountManager || client.accountManager.trim() === '';
                }
                return client.accountManager === managerName;
            });

            if (managerClients.length === 0) {
                return {
                    totalClients: 0,
                    activeClients: 0,
                    avgHealthScore: 0,
                    retentionRate: 0,
                    distribution: { healthy: 0, atRisk: 0, critical: 0, offboarded: 0 }
                };
            }

            const activeClients = managerClients.filter(c => !c.isOffboarded);
            const offboardedClients = managerClients.filter(c => c.isOffboarded);
            
            let totalHealthScore = 0;
            let healthyCount = 0;
            let atRiskCount = 0;
            let criticalCount = 0;

            activeClients.forEach(client => {
                const healthScore = calculateHealthScore(client);
                totalHealthScore += healthScore;
                
                const category = getHealthCategory(healthScore);
                if (category.color === 'healthy') healthyCount++;
                else if (category.color === 'at-risk') atRiskCount++;
                else criticalCount++;
            });

            const avgHealthScore = activeClients.length > 0 ? (totalHealthScore / activeClients.length) : 0;
            const retentionRate = managerClients.length > 0 ? ((activeClients.length / managerClients.length) * 100) : 0;

            return {
                totalClients: managerClients.length,
                activeClients: activeClients.length,
                avgHealthScore: avgHealthScore,
                retentionRate: retentionRate,
                distribution: {
                    healthy: healthyCount,
                    atRisk: atRiskCount,
                    critical: criticalCount,
                    offboarded: offboardedClients.length
                }
            };
        }

        function getUniqueManagers() {
            const managers = new Set();
            let hasUnassigned = false;

            clients.forEach(client => {
                if (client.accountManager && client.accountManager.trim() !== '') {
                    managers.add(client.accountManager.trim());
                } else {
                    hasUnassigned = true;
                }
            });

            const managersList = Array.from(managers).sort();
            if (hasUnassigned) {
                managersList.push('Unassigned');
            }

            return managersList;
        }

        function updateManagerPerformance() {
            const container = document.getElementById('manager-cards-grid');
            const managers = getUniqueManagers();

            if (managers.length === 0) {
                container.innerHTML = '<div class="no-managers-message">No account managers assigned yet. Assign managers to clients to see performance metrics.</div>';
                return;
            }

            container.innerHTML = '';

            managers.forEach(manager => {
                const metrics = calculateManagerMetrics(manager);
                const isUnassigned = manager === 'Unassigned';
                
                const initials = isUnassigned ? '?' : manager.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                
                const card = document.createElement('div');
                card.className = `manager-card ${isUnassigned ? 'no-manager' : ''}`;
                card.onclick = () => filterByManager(manager);
                
                card.innerHTML = `
                    <div class="manager-header">
                        <div class="manager-info">
                            <h3>${isUnassigned ? 'Unassigned Clients' : manager}</h3>
                            <div class="client-count">${metrics.totalClients} total clients</div>
                        </div>
                        <div class="manager-avatar ${isUnassigned ? 'no-manager' : ''}">${initials}</div>
                    </div>
                    
                    <div class="manager-metrics">
                        <div class="metric-item">
                            <div class="metric-value health-score">${metrics.avgHealthScore.toFixed(1)}</div>
                            <div class="metric-label">Avg Health Score</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value retention-rate">${metrics.retentionRate.toFixed(0)}%</div>
                            <div class="metric-label">Retention Rate</div>
                        </div>
                    </div>
                    
                    <div class="client-distribution">
                        <div class="distribution-item healthy">
                            <div>${metrics.distribution.healthy}</div>
                            <div>Healthy</div>
                        </div>
                        <div class="distribution-item at-risk">
                            <div>${metrics.distribution.atRisk}</div>
                            <div>At Risk</div>
                        </div>
                        <div class="distribution-item critical">
                            <div>${metrics.distribution.critical}</div>
                            <div>Critical</div>
                        </div>
                        <div class="distribution-item offboarded">
                            <div>${metrics.distribution.offboarded}</div>
                            <div>Off.</div>
                        </div>
                    </div>
                    
                    <div class="manager-actions">
                        <a href="#" class="action-link" onclick="event.stopPropagation(); filterByManager('${manager}')">View Clients</a>
                        <a href="#" class="action-link secondary" onclick="event.stopPropagation(); scrollToTable()">Go to Table</a>
                    </div>
                `;
                
                container.appendChild(card);
            });

            updateManagerFilter();
        }

        function updateManagerFilter() {
            const managerFilter = document.getElementById('manager-filter');
            const managers = getUniqueManagers();
            
            managerFilter.innerHTML = '<option value="all">All Managers</option>';
            
            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager === 'Unassigned' ? 'Unassigned Clients' : manager;
                managerFilter.appendChild(option);
            });
        }

        function filterByManager(managerName) {
            const managerFilter = document.getElementById('manager-filter');
            managerFilter.value = managerName;
            updateTable();
            scrollToTable();
        }

        function scrollToTable() {
            document.querySelector('.table-section').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function updateAlerts() {
            const alertsContainer = document.getElementById('alerts-container');
            const alertsSection = document.getElementById('alerts-section');
            alertsContainer.innerHTML = '';
            let alertCount = 0;
            let urgentCount = 0;

            const activeClients = clients.filter(c => !c.isOffboarded);

            activeClients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score);

                if (category.color === 'critical' && !dismissedAlerts.has(`critical-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item critical';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Client is in critical status (${score.toFixed(1)})</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('critical-${client.id}', this)">‚úï</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                    urgentCount++;
                }

                if (category.color === 'at-risk' && !dismissedAlerts.has(`at-risk-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item warning';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Client is at risk (${score.toFixed(1)})</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('at-risk-${client.id}', this)">‚úï</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                if (client.sessionShowUp < 60 && !dismissedAlerts.has(`attendance-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item info';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Low show up rate: ${client.sessionShowUp}%</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('attendance-${client.id}', this)">‚úï</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                if (!client.paymentOnTime && !dismissedAlerts.has(`payment-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item critical';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Payment is LATE - This impacts health score by 10%</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('payment-${client.id}', this)">‚úï</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                    urgentCount++;
                }

                if (!client.earlySigns && !dismissedAlerts.has(`earlysigns-${client.id}`)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item warning';
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <h4>${client.name}</h4>
                            <p>Negative early signs feedback - This impacts health score by 20%</p>
                        </div>
                        <button class="dismiss-btn" onclick="dismissAlert('earlysigns-${client.id}', this)">‚úï</button>`;
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }
            });

            document.getElementById('alert-count').textContent = alertCount;
            document.getElementById('urgent-badge').style.display = urgentCount > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentCount + ' Urgent';
            
            alertsSection.style.display = alertCount > 0 ? 'block' : 'none';
        }

        function dismissAlert(alertId, button) {
            dismissedAlerts.add(alertId);
            button.parentElement.remove();
            const alertCount = document.querySelectorAll('.alert-item').length;
            document.getElementById('alert-count').textContent = alertCount;
            
            const urgentAlerts = document.querySelectorAll('.alert-item.critical').length;
            document.getElementById('urgent-badge').style.display = urgentAlerts > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentAlerts + ' Urgent';
            
            if (alertCount === 0) {
                document.getElementById('alerts-section').style.display = 'none';
            }
        }

        function updateCharts() {
            updateScoreChart();
            updateDistributionChart();
        }

        function updateScoreChart() {
            const chartContainer = document.getElementById('score-chart');
            chartContainer.innerHTML = '';

            if (clients.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">No clients to display</div>';
                return;
            }

            const barChart = document.createElement('div');
            barChart.className = 'bar-chart';

            clients.forEach(client => {
                const score = calculateHealthScore(client);
                const category = getHealthCategory(score, client.isOffboarded);
                
                const barContainer = document.createElement('div');
                barContainer.style.flex = '1';
                barContainer.style.position = 'relative';
                barContainer.style.height = '100%';
                
                const bar = document.createElement('div');
                bar.className = `bar ${category.color}`;
                bar.style.height = `${(score / 10 * 100)}%`;
                bar.textContent = client.isOffboarded ? 'OFF' : score.toFixed(1);
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = client.name.length > 10 ? client.name.substring(0, 10) + '...' : client.name;
                
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                barChart.appendChild(barContainer);
            });

            chartContainer.appendChild(barChart);
        }

        function updateDistributionChart() {
            const chartContainer = document.getElementById('distribution-chart');
            chartContainer.innerHTML = '';

            const stats = { healthy: 0, atRisk: 0, critical: 0, offboarded: 0 };
            
            clients.forEach(client => {
                if (client.isOffboarded) {
                    stats.offboarded++;
                } else {
                    const score = calculateHealthScore(client);
                    const category = getHealthCategory(score);
                    if (category.color === 'healthy') stats.healthy++;
                    else if (category.color === 'at-risk') stats.atRisk++;
                    else stats.critical++;
                }
            });

            const total = clients.length;
            if (total === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">No clients to display</div>';
                return;
            }

            const healthyPercent = (stats.healthy / total * 100);
            const atRiskPercent = (stats.atRisk / total * 100);
            const criticalPercent = (stats.critical / total * 100);
            const offboardedPercent = (stats.offboarded / total * 100);

            const pieContainer = document.createElement('div');
            pieContainer.style.width = '200px';
            pieContainer.style.height = '200px';
            pieContainer.style.margin = '0 auto';
            pieContainer.style.borderRadius = '50%';
            pieContainer.style.background = `conic-gradient(
                #16a34a 0% ${healthyPercent}%, 
                #d97706 ${healthyPercent}% ${healthyPercent + atRiskPercent}%, 
                #dc2626 ${healthyPercent + atRiskPercent}% ${healthyPercent + atRiskPercent + criticalPercent}%,
                #6b7280 ${healthyPercent + atRiskPercent + criticalPercent}% 100%)`;

            chartContainer.appendChild(pieContainer);

            const legend = document.createElement('div');
            legend.className = 'chart-legend';
            
            const chartData = [
                { label: 'Healthy', count: stats.healthy, color: '#16a34a' },
                { label: 'At Risk', count: stats.atRisk, color: '#d97706' },
                { label: 'Critical', count: stats.critical, color: '#dc2626' },
                { label: 'Offboarded', count: stats.offboarded, color: '#6b7280' }
            ];

            chartData.forEach(item => {
                if (item.count > 0) {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = item.color;
                    
                    const text = document.createElement('span');
                    text.textContent = `${item.label} (${item.count})`;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(text);
                    legend.appendChild(legendItem);
                }
            });
            
            chartContainer.appendChild(legend);
        }

        function updateTable() {
            const tableBody = document.getElementById('client-table');
            const statusFilter = document.getElementById('client-status-filter').value;
            const managerFilter = document.getElementById('manager-filter').value;
            tableBody.innerHTML = '';

            let filteredClients = clients;
            
            if (statusFilter === 'active') {
                filteredClients = filteredClients.filter(c => !c.isOffboarded);
            } else if (statusFilter === 'offboarded') {
                filteredClients = filteredClients.filter(c => c.isOffboarded);
            }
            
            if (managerFilter !== 'all') {
                if (managerFilter === 'Unassigned') {
                    filteredClients = filteredClients.filter(c => !c.accountManager || c.accountManager.trim() === '');
                } else {
                    filteredClients = filteredClients.filter(c => c.accountManager === managerFilter);
                }
            }

            filteredClients.forEach(client => {
                const healthScore = calculateHealthScore(client);
                const category = getHealthCategory(healthScore, client.isOffboarded);
                const clientMonth = calculateClientMonth(client.joinDate, client.offboardDate);

                const joinDate = client.joinDate ? new Date(client.joinDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : 'N/A';

                const offboardDate = client.offboardDate ? new Date(client.offboardDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : null;

                const row = document.createElement('tr');
                if (client.isOffboarded) {
                    row.className = 'offboarded';
                }
                
                row.innerHTML = `
                    <td>
                        <strong>${client.name}</strong>
                        <div class="join-date">Joined: ${joinDate}</div>
                        ${client.isOffboarded && offboardDate ? `<div class="offboard-date">Offboarded: ${offboardDate}</div>` : ''}
                    </td>
                    <td>
                        <span class="month-indicator">${getOrdinal(clientMonth)} Month</span>
                    </td>
                    <td>
                        <div class="account-manager">${client.accountManager || 'Not assigned'}</div>
                    </td>
                    <td>${client.nps.toFixed(1)}/10</td>
                    <td>${client.sessionShowUp}%</td>
                    <td>${client.participationLevel.toFixed(1)}/10</td>
                    <td>
                        <span class="status-badge ${client.paymentOnTime ? 'healthy' : 'critical'}">
                            ${client.paymentOnTime ? '‚úì On Time' : '‚ö† Late'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${client.videoWentViral ? 'healthy' : 'critical'}">
                            ${client.videoWentViral ? 'üî• Yes' : '‚ùå No'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${client.earlySigns ? 'healthy' : 'critical'}">
                            ${client.earlySigns ? 'üëç Positive' : 'üëé Negative'}
                        </span>
                    </td>
                    <td><strong>${client.isOffboarded ? 'N/A' : healthScore.toFixed(1)}</strong></td>
                    <td><span class="status-badge ${category.color}">${category.label}</span></td>
                    <td>
                        <div class="notes">${client.notes || ''}</div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${!client.isOffboarded ? `
                                <button class="action-btn edit-btn" onclick="editClient('${client.id}')" title="Edit Client">‚úèÔ∏è</button>
                                <button class="action-btn offboard-btn" onclick="openOffboardModal('${client.id}')" title="Offboard Client">üèÉ‚Äç‚ôÇÔ∏è</button>
                            ` : `
                                <button class="action-btn reactivate-btn" onclick="reactivateClient('${client.id}')" title="Reactivate Client">üîÑ</button>
                            `}
                            <button class="action-btn delete-btn" onclick="deleteClient('${client.id}')" title="Delete Client">üóëÔ∏è</button>
                        </div>
                    </td>`;
                
                tableBody.appendChild(row);
            });
        }

        function getOrdinal(num) {
            const suffixes = ["th", "st", "nd", "rd"];
            const v = num % 100;
            return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        function toggleForm() {
            const form = document.getElementById('client-form');
            form.classList.toggle('hidden');
            
            if (!form.classList.contains('hidden')) {
                resetForm();
            }
        }

        function resetForm() {
            currentEditingClientId = null;
            document.getElementById('form-title').textContent = 'Add New Client';
            document.getElementById('submit-btn').textContent = 'Add Client';
            document.getElementById('submit-btn').onclick = addClient;
            
            document.getElementById('name').value = '';
            document.getElementById('join-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('account-manager').value = '';
            document.getElementById('nps').value = '7';
            document.getElementById('showup').value = '85';
            document.getElementById('participation').value = '7';
            document.getElementById('payment-status').value = 'true';
            document.getElementById('video-viral').value = 'false';
            document.getElementById('early-signs').value = 'true';
            document.getElementById('notes').value = '';
        }

        function cancelForm() {
            const form = document.getElementById('client-form');
            form.classList.add('hidden');
            resetForm();
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) {
                alert('Client not found');
                return;
            }

            if (client.isOffboarded) {
                alert('Cannot edit offboarded clients. Please reactivate first.');
                return;
            }

            currentEditingClientId = id;
            
            document.getElementById('form-title').textContent = 'Edit Client';
            document.getElementById('submit-btn').textContent = 'Update Client';
            document.getElementById('submit-btn').onclick = updateClient;
            
            document.getElementById('name').value = client.name;
            document.getElementById('join-date').value = client.joinDate || '';
            document.getElementById('account-manager').value = client.accountManager || '';
            document.getElementById('nps').value = client.nps;
            document.getElementById('showup').value = client.sessionShowUp;
            document.getElementById('participation').value = client.participationLevel;
            document.getElementById('payment-status').value = (client.paymentOnTime !== undefined ? client.paymentOnTime : true).toString();
            document.getElementById('video-viral').value = (client.videoWentViral !== undefined ? client.videoWentViral : false).toString();
            document.getElementById('early-signs').value = (client.earlySigns !== undefined ? client.earlySigns : true).toString();
            document.getElementById('notes').value = client.notes || '';
            
            document.getElementById('client-form').classList.remove('hidden');
        }

        function updateClient() {
            if (!currentEditingClientId) {
                alert('No client selected for editing');
                return;
            }

            const name = document.getElementById('name').value.trim();
            const joinDate = document.getElementById('join-date').value;
            const accountManager = document.getElementById('account-manager').value.trim();
            const nps = parseFloat(document.getElementById('nps').value) || 7;
            const sessionShowUp = parseInt(document.getElementById('showup').value) || 85;
            const participationLevel = parseFloat(document.getElementById('participation').value) || 7;
            const paymentOnTime = document.getElementById('payment-status').value === 'true';
            const videoWentViral = document.getElementById('video-viral').value === 'true';
            const earlySigns = document.getElementById('early-signs').value === 'true';
            const notes = document.getElementById('notes').value.trim();

            if (!name) {
                alert('Please enter a client name');
                return;
            }

            if (!joinDate) {
                alert('Please select a join date');
                return;
            }

            const existingClient = clients.find(c => c.id === currentEditingClientId);
            if (!existingClient) {
                alert('Client not found');
                return;
            }

            const tempClient = {
                nps: nps,
                sessionShowUp: sessionShowUp,
                participationLevel: participationLevel,
                paymentOnTime: paymentOnTime,
                videoWentViral: videoWentViral,
                earlySigns: earlySigns
            };
            const newScore = calculateHealthScore(tempClient);

            const updatedClient = {
                ...existingClient,
                name: name,
                joinDate: joinDate,
                accountManager: accountManager,
                nps: nps,
                sessionShowUp: sessionShowUp,
                participationLevel: participationLevel,
                paymentOnTime: paymentOnTime,
                videoWentViral: videoWentViral,
                earlySigns: earlySigns,
                notes: notes,
                updatedAt: new Date().toISOString()
            };

            if (!updatedClient.timeline) {
                updatedClient.timeline = [];
            }
            
            updatedClient.timeline.push({
                date: new Date().toISOString().split('T')[0],
                event: "Client Data Updated",
                score: newScore,
                type: "update"
            });

            clientsRef.child(currentEditingClientId).set(updatedClient);

            cancelForm();
            
            alert('Client updated successfully!');
        }

        function addClient() {
            const name = document.getElementById('name').value.trim();
            const joinDate = document.getElementById('join-date').value;
            const accountManager = document.getElementById('account-manager').value.trim();
            const nps = parseFloat(document.getElementById('nps').value) || 7;
            const sessionShowUp = parseInt(document.getElementById('showup').value) || 85;
            const participationLevel = parseFloat(document.getElementById('participation').value) || 7;
            const paymentOnTime = document.getElementById('payment-status').value === 'true';
            const videoWentViral = document.getElementById('video-viral').value === 'true';
            const earlySigns = document.getElementById('early-signs').value === 'true';
            const notes = document.getElementById('notes').value.trim();

            if (!name) {
                alert('Please enter a client name');
                return;
            }

            if (!joinDate) {
                alert('Please select a join date');
                return;
            }

            const tempClient = {
                nps: nps,
                sessionShowUp: sessionShowUp,
                participationLevel: participationLevel,
                paymentOnTime: paymentOnTime,
                videoWentViral: videoWentViral,
                earlySigns: earlySigns
            };
            const currentScore = calculateHealthScore(tempClient);

            const newClient = {
                id: Date.now().toString(),
                name: name,
                joinDate: joinDate,
                accountManager: accountManager,
                nps: nps,
                sessionShowUp: sessionShowUp,
                participationLevel: participationLevel,
                paymentOnTime: paymentOnTime,
                videoWentViral: videoWentViral,
                earlySigns: earlySigns,
                notes: notes,
                isOffboarded: false,
                timeline: [
                    { 
                        date: joinDate, 
                        event: "Client Onboarded", 
                        score: currentScore, 
                        type: "milestone" 
                    }
                ],
                createdAt: new Date().toISOString()
            };

            clientsRef.child(newClient.id).set(newClient);

            resetForm();
            toggleForm();
        }

        function deleteClient(id) {
            const client = clients.find(c => c.id === id);
            const clientName = client ? client.name : 'this client';
            
            if (confirm(`Are you sure you want to permanently delete ${clientName}? This action cannot be undone.`)) {
                clientsRef.child(id).remove();
            }
        }

        function updateSyncIndicator(isConnected) {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            
            if (isConnected) {
                dot.classList.remove('offline');
                status.textContent = 'Connected';
            } else {
                dot.classList.add('offline');
                status.textContent = 'Offline';
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('offboard-modal');
            if (event.target === modal) {
                closeOffboardModal();
            }
        }

        clientsRef.on('value', (snapshot) => {
            clients = [];
            snapshot.forEach((childSnapshot) => {
                clients.push(childSnapshot.val());
            });
            updateDashboard();
        });

        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
            updateSyncIndicator(snapshot.val() === true);
        });

        // Initialize with sample data if database is empty
        clientsRef.once('value', (snapshot) => {
            if (!snapshot.exists()) {
                const sampleClients = [
                    {
                        id: '1',
                        name: "Healthy Client Co.",
                        joinDate: "2024-01-15",
                        accountManager: "Sarah Johnson",
                        nps: 9,
                        sessionShowUp: 95,
                        participationLevel: 8.5,
                        paymentOnTime: true,
                        videoWentViral: true,
                        earlySigns: true,
                        notes: "Excellent engagement, viral video last month",
                        isOffboarded: false,
                        timeline: [
                            { date: "2024-01-15", event: "Client Onboarded", score: 9.2, type: "milestone" }
                        ]
                    },
                    {
                        id: '2',
                        name: "At-Risk Client Inc.",
                        joinDate: "2024-03-01",
                        accountManager: "Mike Chen",
                        nps: 7,
                        sessionShowUp: 75,
                        participationLevel: 6,
                        paymentOnTime: true,
                        videoWentViral: false,
                        earlySigns: true,
                        notes: "Needs more engagement, no viral content yet",
                        isOffboarded: false,
                        timeline: [
                            { date: "2024-03-01", event: "Client Onboarded", score: 7.1, type: "milestone" }
                        ]
                    },
                    {
                        id: '3',
                        name: "Critical Client LLC",
                        joinDate: "2024-06-10",
                        accountManager: "Jennifer Rodriguez",
                        nps: 4,
                        sessionShowUp: 45,
                        participationLevel: 3,
                        paymentOnTime: false,
                        videoWentViral: false,
                        earlySigns: false,
                        notes: "Requires immediate intervention - payment late, negative feedback",
                        isOffboarded: false,
                        timeline: [
                            { date: "2024-06-10", event: "Client Onboarded", score: 4.2, type: "milestone" }
                        ]
                    }
                ];

                sampleClients.forEach(client => {
                    clientsRef.child(client.id).set(client);
                });
            }
        });
    </script>
</body>
</html>
