<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Retention Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 24px;
        }
        
        .stat-icon.blue { background-color: #dbeafe; color: #2563eb; }
        .stat-icon.green { background-color: #dcfce7; color: #16a34a; }
        .stat-icon.yellow { background-color: #fef3c7; color: #d97706; }
        .stat-icon.red { background-color: #fee2e2; color: #dc2626; }
        
        .stat-info h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .stat-info p {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn:hover {
            background-color: #1d4ed8;
        }
        
        .btn-success {
            background-color: #16a34a;
        }
        
        .btn-success:hover {
            background-color: #15803d;
        }
        
        .btn-secondary {
            background-color: #6b7280;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .form-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .form-group input, .form-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .table-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-badge.healthy {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-badge.at-risk {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.critical {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .details {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        
        .alerts-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .alerts-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }
        
        .alerts-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .alert-urgent {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .alert-item {
            padding: 16px;
            border-radius: 6px;
            border: 1px solid;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        
        .alert-item.critical {
            background-color: #fef2f2;
            border-color: #fecaca;
        }
        
        .alert-item.warning {
            background-color: #fffbeb;
            border-color: #fed7aa;
        }
        
        .alert-item.info {
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-content h4 {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .alert-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dismiss-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .bar-chart {
            display: flex;
            align-items: end;
            height: 200px;
            gap: 12px;
            padding: 20px 0;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, #e5e7eb, #3b82f6);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 20px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            padding-bottom: 8px;
        }
        
        .bar.healthy {
            background: linear-gradient(to top, #dcfce7, #16a34a);
        }
        
        .bar.at-risk {
            background: linear-gradient(to top, #fef3c7, #d97706);
        }
        
        .bar.critical {
            background: linear-gradient(to top, #fee2e2, #dc2626);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
            width: 100%;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }
        
        .pie-slice {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .legend-color.healthy { background-color: #16a34a; }
        .legend-color.at-risk { background-color: #d97706; }
        .time-filter-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .time-filter-header {
            margin-bottom: 20px;
        }
        
        .time-filter-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #111827;
        }
        
        .time-filter-header p {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .time-filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background-color: #f9fafb;
            border-radius: 6px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
            background-color: white;
        }
        
        .time-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 6px;
            text-align: center;
        }
        
        .insight-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .insight-card:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .insight-card:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .insight-card h4 {
            font-size: 0.875rem;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .insight-card p {
            font-size: 0.875rem;
            margin: 0;
        }
        
        .insight-card strong {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .timeline-view {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .timeline-container {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-line {
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #10b981, #f59e0b, #ef4444);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 24px;
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            margin-left: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid white;
            box-shadow: 0 0 0 3px #10b981;
        }
        
        .timeline-item.warning::before {
            background: #f59e0b;
            box-shadow: 0 0 0 3px #f59e0b;
        }
        
        .timeline-item.critical::before {
            background: #ef4444;
            box-shadow: 0 0 0 3px #ef4444;
        }
        
        .timeline-date {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .timeline-content h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Customer Retention Dashboard</h1>
            <p>Monitor customer health scores and retention metrics</p>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">ðŸ‘¥</div>
                <div class="stat-info">
                    <h3>Total Customers</h3>
                    <p id="total-customers">3</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">âœ“</div>
                <div class="stat-info">
                    <h3>Healthy</h3>
                    <p id="healthy-customers" style="color: #16a34a;">1</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow">âš </div>
                <div class="stat-info">
                    <h3>At Risk</h3>
                    <p id="at-risk-customers" style="color: #d97706;">1</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">ðŸ“‰</div>
                <div class="stat-info">
                    <h3>Critical</h3>
                    <p id="critical-customers" style="color: #dc2626;">1</p>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section" id="alerts-section">
            <div class="alerts-header">
                <span style="font-size: 24px;">ðŸ””</span>
                <h2>Active Alerts (<span id="alert-count">0</span>)</h2>
                <span class="alert-urgent" id="urgent-badge" style="display: none;">0 Urgent</span>
            </div>
            <div class="alerts-grid" id="alerts-container">
                <!-- Alerts will be inserted here -->
            </div>
        </div>

        <!-- Time Frame Analysis -->
        <div class="time-filter-section">
            <div class="time-filter-header">
                <h3>ðŸ“… Time Analysis</h3>
                <p>Analyze customer health across different time periods</p>
            </div>
            <div class="time-filter-controls">
                <div class="filter-group">
                    <label>Time Period:</label>
                    <select id="time-period" onchange="updateTimeFrame()">
                        <option value="lifetime">Lifetime (All Time)</option>
                        <option value="12months">Last 12 Months</option>
                        <option value="6months">Last 6 Months</option>
                        <option value="3months">Last 3 Months</option>
                        <option value="1month">Last Month</option>
                        <option value="current">Current Period</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>View Type:</label>
                    <select id="view-type" onchange="updateTimeFrame()">
                        <option value="summary">Summary View</option>
                        <option value="timeline">Customer Timeline</option>
                        <option value="trends">Trend Analysis</option>
                    </select>
                </div>
            </div>
            <div class="time-insights" id="time-insights">
                <!-- Insights will be populated here -->
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3>Health Score Overview</h3>
                <div class="chart-container" id="score-chart">
                    <!-- Chart will be generated here -->
                </div>
            </div>
            <div class="chart-card">
                <h3>Customer Distribution</h3>
                <div class="chart-container" id="distribution-chart">
                    <!-- Chart will be generated here -->
                </div>
            </div>
        </div>

        <!-- Add Customer Button -->
        <button class="btn" onclick="toggleForm()">
            âž• Add Customer
        </button>

        <!-- Add Customer Form -->
        <div class="form-section hidden" id="customer-form">
            <h3 style="margin-bottom: 16px;">Add New Customer</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="name" placeholder="Enter customer name">
                </div>
                <div class="form-group">
                    <label>NPS Score (0-10)</label>
                    <input type="number" id="nps" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Session Show Up (%)</label>
                    <input type="number" id="showup" min="0" max="100" value="85">
                </div>
                <div class="form-group">
                    <label>Response Time (days)</label>
                    <input type="number" id="response" min="0" step="0.1" value="2">
                </div>
                <div class="form-group">
                    <label>Participation Level (0-10)</label>
                    <input type="number" id="participation" min="0" max="10" step="0.1" value="7">
                </div>
                <div class="form-group">
                    <label>Session Scheduled</label>
                    <select id="scheduled">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Survey Filled</label>
                    <select id="survey">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
            </div>
            <div>
                <button class="btn btn-success" onclick="addCustomer()">Add Customer</button>
                <button class="btn btn-secondary" onclick="toggleForm()">Cancel</button>
            </div>
        </div>

        <!-- Customer Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>Customer Health Scores</h2>
            </div>
            <div>
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>NPS</th>
                            <th>Engagement</th>
                            <th>Health Score</th>
                            <th>Status</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customer-table">
                        <!-- Customers will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Enhanced customer data with timeline
        var customers = [
            {
                id: 1,
                name: "Acme Corp",
                nps: 9,
                sessionShowUp: 95,
                messageResponseTime: 1,
                sessionScheduled: true,
                participationLevel: 8.5,
                surveyFilled: true,
                startDate: "2023-01-15",
                timeline: [
                    { date: "2023-01-15", event: "Customer Onboarded", score: 7.5, type: "milestone" },
                    { date: "2023-03-20", event: "First Health Check", score: 8.0, type: "assessment" },
                    { date: "2023-06-10", event: "Quarterly Review", score: 8.3, type: "review" },
                    { date: "2023-09-15", event: "Contract Renewal", score: 8.7, type: "milestone" },
                    { date: "2024-01-20", event: "Annual Review", score: 9.0, type: "review" },
                    { date: "2024-12-01", event: "Current Status", score: 9.0, type: "current" }
                ]
            },
            {
                id: 2,
                name: "TechStart Inc",
                nps: 7,
                sessionShowUp: 75,
                messageResponseTime: 2.5,
                sessionScheduled: false,
                participationLevel: 6,
                surveyFilled: true,
                startDate: "2023-06-01",
                timeline: [
                    { date: "2023-06-01", event: "Customer Onboarded", score: 8.2, type: "milestone" },
                    { date: "2023-08-15", event: "First Health Check", score: 7.8, type: "assessment" },
                    { date: "2023-11-30", event: "Quarterly Review", score: 7.5, type: "review" },
                    { date: "2024-03-10", event: "Support Escalation", score: 7.2, type: "incident" },
                    { date: "2024-06-01", event: "Contract Renewal", score: 7.1, type: "milestone" },
                    { date: "2024-12-01", event: "Current Status", score: 7.1, type: "current" }
                ]
            },
            {
                id: 3,
                name: "Global Solutions",
                nps: 4,
                sessionShowUp: 45,
                messageResponseTime: 5,
                sessionScheduled: false,
                participationLevel: 3,
                surveyFilled: false,
                startDate: "2024-02-10",
                timeline: [
                    { date: "2024-02-10", event: "Customer Onboarded", score: 6.8, type: "milestone" },
                    { date: "2024-04-15", event: "First Health Check", score: 6.2, type: "assessment" },
                    { date: "2024-07-20", event: "Quarterly Review", score: 5.5, type: "review" },
                    { date: "2024-09-30", event: "Escalation Required", score: 4.8, type: "incident" },
                    { date: "2024-12-01", event: "Critical Status", score: 4.2, type: "current" }
                ]
            }
        ];

        // Time frame analysis functions
        function updateTimeFrame() {
            var period = document.getElementById('time-period').value;
            var viewType = document.getElementById('view-type').value;
            
            updateTimeInsights(period);
            updateTimelineView(viewType, period);
        }

        function updateTimeInsights(period) {
            var insights = calculateTimeInsights(period);
            var insightsContainer = document.getElementById('time-insights');
            
            insightsContainer.innerHTML = 
                '<div class="insight-card">' +
                    '<h4>ðŸ“ˆ Average Relationship</h4>' +
                    '<p>' + insights.avgRelationship + '</p>' +
                '</div>' +
                '<div class="insight-card">' +
                    '<h4>ðŸŽ¯ Retention Rate</h4>' +
                    '<p>' + insights.retentionRate + '</p>' +
                '</div>' +
                '<div class="insight-card">' +
                    '<h4>âš¡ Health Trend</h4>' +
                    '<p>' + insights.healthTrend + '</p>' +
                '</div>' +
                '<div class="insight-card">' +
                    '<h4>ðŸš¨ Risk Analysis</h4>' +
                    '<p>' + insights.riskAnalysis + '</p>' +
                '</div>';
        }

        function calculateTimeInsights(period) {
            var totalMonths = 0;
            var healthChanges = [];
            var retainedCustomers = 0;
            
            for (var i = 0; i < customers.length; i++) {
                var customer = customers[i];
                if (customer.startDate) {
                    var startDate = new Date(customer.startDate);
                    var currentDate = new Date();
                    var monthsDiff = (currentDate - startDate) / (1000 * 60 * 60 * 24 * 30);
                    totalMonths += monthsDiff;
                }
                
                if (customer.timeline && customer.timeline.length > 1) {
                    var firstScore = customer.timeline[0].score;
                    var lastScore = customer.timeline[customer.timeline.length - 1].score;
                    healthChanges.push(lastScore - firstScore);
                }
                
                if (calculateHealthScore(customer) >= 7) {
                    retainedCustomers++;
                }
            }
            
            var avgRelationship = customers.length > 0 ? (totalMonths / customers.length).toFixed(1) : 0;
            var retentionRate = customers.length > 0 ? ((retainedCustomers / customers.length) * 100).toFixed(0) : 0;
            var avgHealthChange = healthChanges.length > 0 ? healthChanges.reduce(function(a, b) { return a + b; }, 0) / healthChanges.length : 0;
            var trendDirection = avgHealthChange > 0 ? 'Improving' : avgHealthChange < 0 ? 'Declining' : 'Stable';
            
            return {
                avgRelationship: '<strong>' + avgRelationship + ' months</strong>',
                retentionRate: '<strong>' + retentionRate + '%</strong> healthy customers',
                healthTrend: '<strong>' + trendDirection + ' (' + (avgHealthChange > 0 ? '+' : '') + avgHealthChange.toFixed(1) + ')</strong>',
                riskAnalysis: '<strong>' + customers.filter(function(c) { return calculateHealthScore(c) < 7; }).length + '</strong> customers at risk'
            };
        }

        function updateTimelineView(viewType, period) {
            // Remove existing timeline
            var existingTimeline = document.querySelector('.timeline-view');
            if (existingTimeline) {
                existingTimeline.remove();
            }
            
            if (viewType === 'timeline' || viewType === 'trends') {
                createTimelineView(viewType, period);
            }
        }

        function createTimelineView(viewType, period) {
            var timelineDiv = document.createElement('div');
            timelineDiv.className = 'timeline-view';
            
            timelineDiv.innerHTML = 
                '<div class="timeline-header">' +
                    '<h3>' + (viewType === 'timeline' ? 'ðŸ“‹ Customer Timeline' : 'ðŸ“ˆ Trend Analysis') + '</h3>' +
                    '<span style="font-size: 0.875rem; color: #6b7280;">Showing ' + (period === 'lifetime' ? 'all historical data' : period) + '</span>' +
                '</div>' +
                '<div class="timeline-container">' +
                    '<div class="timeline-line"></div>' +
                    generateTimelineItems(viewType, period) +
                '</div>';
            
            var chartsSection = document.querySelector('.charts-section');
            chartsSection.parentNode.insertBefore(timelineDiv, chartsSection);
        }

        function generateTimelineItems(viewType, period) {
            var allEvents = [];
            
            for (var i = 0; i < customers.length; i++) {
                var customer = customers[i];
                if (customer.timeline) {
                    for (var j = 0; j < customer.timeline.length; j++) {
                        var event = customer.timeline[j];
                        allEvents.push({
                            date: event.date,
                            event: event.event,
                            score: event.score,
                            type: event.type,
                            customerName: customer.name,
                            customerId: customer.id
                        });
                    }
                }
            }
            
            // Sort by date
            allEvents.sort(function(a, b) {
                return new Date(a.date) - new Date(b.date);
            });
            
            // Filter by period if not lifetime
            if (period !== 'lifetime') {
                var cutoffDate = new Date();
                switch(period) {
                    case '1month':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 1);
                        break;
                    case '3months':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 3);
                        break;
                    case '6months':
                        cutoffDate.setMonth(cutoffDate.getMonth() - 6);
                        break;
                    case '12months':
                        cutoffDate.setFullYear(cutoffDate.getFullYear() - 1);
                        break;
                }
                allEvents = allEvents.filter(function(event) {
                    return new Date(event.date) >= cutoffDate;
                });
            }
            
            var timelineHTML = '';
            for (var i = 0; i < allEvents.length; i++) {
                var event = allEvents[i];
                var eventClass = event.score < 7 ? 'critical' : event.score < 8 ? 'warning' : '';
                var formattedDate = new Date(event.date).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                timelineHTML += 
                    '<div class="timeline-item ' + eventClass + '">' +
                        '<div class="timeline-date">' + formattedDate + '</div>' +
                        '<div class="timeline-content">' +
                            '<h4>' + event.customerName + ': ' + event.event + '</h4>' +
                            '<p>Health Score: ' + event.score.toFixed(1) + ' | Type: ' + event.type + '</p>' +
                        '</div>' +
                    '</div>';
            }
            
            return timelineHTML;
        }

        // Initialize time frame on load
        function initializeTimeFrame() {
            updateTimeFrame();
        }

        // Calculate engagement score
        function calculateEngagementScore(customer) {
            var sessionScore = customer.sessionShowUp >= 90 ? 10 : customer.sessionShowUp >= 60 ? 7.5 : 3;
            var responseScore = customer.messageResponseTime <= 2 ? 10 : customer.messageResponseTime <= 3 ? 7.5 : 3;
            var scheduleScore = customer.sessionScheduled ? 10 : 3;
            var participationScore = customer.participationLevel;
            var surveyScore = customer.surveyFilled ? 10 : 3;

            return (sessionScore * 0.4) + (responseScore * 0.1) + (scheduleScore * 0.05) + (participationScore * 0.35) + (surveyScore * 0.1);
        }

        // Calculate health score
        function calculateHealthScore(customer) {
            var npsScore = customer.nps;
            var engagementScore = calculateEngagementScore(customer);
            return (npsScore * 0.6) + (engagementScore * 0.4);
        }

        // Get health category
        function getHealthCategory(score) {
            if (score >= 8) return { color: 'healthy', label: 'Healthy' };
            if (score >= 7) return { color: 'at-risk', label: 'At Risk' };
            return { color: 'critical', label: 'Critical' };
        }

        // Update dashboard
        function updateDashboard() {
            var stats = { total: customers.length, healthy: 0, atRisk: 0, critical: 0 };
            
            for (var i = 0; i < customers.length; i++) {
                var score = calculateHealthScore(customers[i]);
                var category = getHealthCategory(score);
                if (category.color === 'healthy') stats.healthy++;
                else if (category.color === 'at-risk') stats.atRisk++;
                else stats.critical++;
            }

            document.getElementById('total-customers').textContent = stats.total;
            document.getElementById('healthy-customers').textContent = stats.healthy;
            document.getElementById('at-risk-customers').textContent = stats.atRisk;
            document.getElementById('critical-customers').textContent = stats.critical;

            updateTable();
            updateAlerts();
            updateCharts();
        }

        // Update charts
        function updateCharts() {
            updateScoreChart();
            updateDistributionChart();
        }

        // Update score chart (bar chart showing individual customer scores)
        function updateScoreChart() {
            var chartContainer = document.getElementById('score-chart');
            chartContainer.innerHTML = '';

            var barChart = document.createElement('div');
            barChart.className = 'bar-chart';

            for (var i = 0; i < customers.length; i++) {
                var customer = customers[i];
                var score = calculateHealthScore(customer);
                var category = getHealthCategory(score);
                
                var barContainer = document.createElement('div');
                barContainer.style.flex = '1';
                barContainer.style.position = 'relative';
                barContainer.style.height = '100%';
                
                var bar = document.createElement('div');
                bar.className = 'bar ' + category.color;
                bar.style.height = (score / 10 * 100) + '%';
                bar.textContent = score.toFixed(1);
                
                var label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = customer.name.length > 10 ? customer.name.substring(0, 10) + '...' : customer.name;
                
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                barChart.appendChild(barContainer);
            }

            chartContainer.appendChild(barChart);
        }

        // Update distribution chart (pie chart showing healthy vs at-risk vs critical)
        function updateDistributionChart() {
            var chartContainer = document.getElementById('distribution-chart');
            chartContainer.innerHTML = '';

            var stats = { healthy: 0, atRisk: 0, critical: 0 };
            
            for (var i = 0; i < customers.length; i++) {
                var score = calculateHealthScore(customers[i]);
                var category = getHealthCategory(score);
                if (category.color === 'healthy') stats.healthy++;
                else if (category.color === 'at-risk') stats.atRisk++;
                else stats.critical++;
            }

            var total = customers.length;
            if (total === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">No customers to display</div>';
                return;
            }

            // Create simple pie chart using CSS
            var pieChart = document.createElement('div');
            pieChart.className = 'pie-chart';
            
            var healthyPercent = (stats.healthy / total * 100);
            var atRiskPercent = (stats.atRisk / total * 100);
            var criticalPercent = (stats.critical / total * 100);

            // Create pie chart visualization (simplified)
            var chartData = [
                { label: 'Healthy', count: stats.healthy, percent: healthyPercent, color: '#16a34a' },
                { label: 'At Risk', count: stats.atRisk, percent: atRiskPercent, color: '#d97706' },
                { label: 'Critical', count: stats.critical, percent: criticalPercent, color: '#dc2626' }
            ];

            // Simple pie chart representation
            var pieContainer = document.createElement('div');
            pieContainer.style.width = '200px';
            pieContainer.style.height = '200px';
            pieContainer.style.margin = '0 auto';
            pieContainer.style.borderRadius = '50%';
            pieContainer.style.background = 'conic-gradient(' +
                '#16a34a 0% ' + healthyPercent + '%, ' +
                '#d97706 ' + healthyPercent + '% ' + (healthyPercent + atRiskPercent) + '%, ' +
                '#dc2626 ' + (healthyPercent + atRiskPercent) + '% 100%)';

            chartContainer.appendChild(pieContainer);

            // Add legend
            var legend = document.createElement('div');
            legend.className = 'chart-legend';
            
            for (var i = 0; i < chartData.length; i++) {
                if (chartData[i].count > 0) {
                    var legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    
                    var colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = chartData[i].color;
                    
                    var text = document.createElement('span');
                    text.textContent = chartData[i].label + ' (' + chartData[i].count + ')';
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(text);
                    legend.appendChild(legendItem);
                }
            }
            
            chartContainer.appendChild(legend);
        }

        // Update alerts
        function updateAlerts() {
            var alertsContainer = document.getElementById('alerts-container');
            var alertsSection = document.getElementById('alerts-section');
            alertsContainer.innerHTML = '';
            var alertCount = 0;
            var urgentCount = 0;

            for (var i = 0; i < customers.length; i++) {
                var customer = customers[i];
                var score = calculateHealthScore(customer);
                var category = getHealthCategory(score);

                // Critical alerts
                if (category.color === 'critical') {
                    var alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item critical';
                    alertDiv.innerHTML = 
                        '<div class="alert-content">' +
                            '<h4>' + customer.name + '</h4>' +
                            '<p>Customer is in critical status (' + score.toFixed(1) + ')</p>' +
                        '</div>' +
                        '<button class="dismiss-btn" onclick="dismissAlert(this)">âœ•</button>';
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                    urgentCount++;
                }

                // At-risk alerts
                if (category.color === 'at-risk') {
                    var alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item warning';
                    alertDiv.innerHTML = 
                        '<div class="alert-content">' +
                            '<h4>' + customer.name + '</h4>' +
                            '<p>Customer is at risk (' + score.toFixed(1) + ')</p>' +
                        '</div>' +
                        '<button class="dismiss-btn" onclick="dismissAlert(this)">âœ•</button>';
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                // Low attendance alerts
                if (customer.sessionShowUp < 60) {
                    var alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item info';
                    alertDiv.innerHTML = 
                        '<div class="alert-content">' +
                            '<h4>' + customer.name + '</h4>' +
                            '<p>Low session attendance: ' + customer.sessionShowUp + '%</p>' +
                        '</div>' +
                        '<button class="dismiss-btn" onclick="dismissAlert(this)">âœ•</button>';
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }

                // Slow response alerts
                if (customer.messageResponseTime > 3) {
                    var alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item info';
                    alertDiv.innerHTML = 
                        '<div class="alert-content">' +
                            '<h4>' + customer.name + '</h4>' +
                            '<p>Slow response time: ' + customer.messageResponseTime + ' days</p>' +
                        '</div>' +
                        '<button class="dismiss-btn" onclick="dismissAlert(this)">âœ•</button>';
                    alertsContainer.appendChild(alertDiv);
                    alertCount++;
                }
            }

            document.getElementById('alert-count').textContent = alertCount;
            document.getElementById('urgent-badge').style.display = urgentCount > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentCount + ' Urgent';
            
            // Hide alerts section if no alerts
            alertsSection.style.display = alertCount > 0 ? 'block' : 'none';
        }

        // Dismiss alert
        function dismissAlert(button) {
            button.parentElement.remove();
            var alertCount = document.querySelectorAll('.alert-item').length;
            document.getElementById('alert-count').textContent = alertCount;
            
            var urgentAlerts = document.querySelectorAll('.alert-item.critical').length;
            document.getElementById('urgent-badge').style.display = urgentAlerts > 0 ? 'inline' : 'none';
            document.getElementById('urgent-badge').textContent = urgentAlerts + ' Urgent';
            
            // Hide alerts section if no alerts left
            if (alertCount === 0) {
                document.getElementById('alerts-section').style.display = 'none';
            }
        }

        // Update table
        function updateTable() {
            var tableBody = document.getElementById('customer-table');
            tableBody.innerHTML = '';

            for (var i = 0; i < customers.length; i++) {
                var customer = customers[i];
                var healthScore = calculateHealthScore(customer);
                var engagementScore = calculateEngagementScore(customer);
                var category = getHealthCategory(healthScore);

                var row = document.createElement('tr');
                row.innerHTML = 
                    '<td><strong>' + customer.name + '</strong></td>' +
                    '<td>' + customer.nps.toFixed(1) + '</td>' +
                    '<td>' + engagementScore.toFixed(1) + '</td>' +
                    '<td><strong>' + healthScore.toFixed(1) + '</strong></td>' +
                    '<td><span class="status-badge ' + category.color + '">' + category.label + '</span></td>' +
                    '<td class="details">' +
                        'Show Up: ' + customer.sessionShowUp + '%<br>' +
                        'Response: ' + customer.messageResponseTime + 'd<br>' +
                        'Scheduled: ' + (customer.sessionScheduled ? 'Yes' : 'No') + '<br>' +
                        'Participation: ' + customer.participationLevel + '<br>' +
                        'Survey: ' + (customer.surveyFilled ? 'Yes' : 'No') +
                    '</td>' +
                    '<td><button class="delete-btn" onclick="deleteCustomer(' + customer.id + ')">ðŸ—‘</button></td>';
                
                tableBody.appendChild(row);
            }
        }

        // Toggle form
        function toggleForm() {
            var form = document.getElementById('customer-form');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
            } else {
                form.classList.add('hidden');
            }
        }

        // Add customer
        function addCustomer() {
            var name = document.getElementById('name').value.trim();
            var nps = parseFloat(document.getElementById('nps').value) || 7;
            var sessionShowUp = parseInt(document.getElementById('showup').value) || 85;
            var messageResponseTime = parseFloat(document.getElementById('response').value) || 2;
            var participationLevel = parseFloat(document.getElementById('participation').value) || 7;
            var sessionScheduled = document.getElementById('scheduled').value === 'true';
            var surveyFilled = document.getElementById('survey').value === 'true';

            if (!name) {
                alert('Please enter a customer name');
                return;
            }

            var newCustomer = {
                id: Date.now(),
                name: name,
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled
            };

            customers.push(newCustomer);
            updateDashboard();

            // Clear form
            document.getElementById('name').value = '';
            document.getElementById('nps').value = '7';
            document.getElementById('showup').value = '85';
            document.getElementById('response').value = '2';
            document.getElementById('participation').value = '7';
            document.getElementById('scheduled').value = 'true';
            document.getElementById('survey').value = 'true';

            toggleForm();
            alert('Customer "' + name + '" added successfully!');
        }

        // Delete customer
        function deleteCustomer(id) {
            customers = customers.filter(function(customer) {
                return customer.id !== id;
            });
            updateDashboard();
        }

        // Add customer with timeline support
        function addCustomer() {
            var name = document.getElementById('name').value.trim();
            var nps = parseFloat(document.getElementById('nps').value) || 7;
            var sessionShowUp = parseInt(document.getElementById('showup').value) || 85;
            var messageResponseTime = parseFloat(document.getElementById('response').value) || 2;
            var participationLevel = parseFloat(document.getElementById('participation').value) || 7;
            var sessionScheduled = document.getElementById('scheduled').value === 'true';
            var surveyFilled = document.getElementById('survey').value === 'true';

            if (!name) {
                alert('Please enter a customer name');
                return;
            }

            var currentDate = new Date().toISOString().split('T')[0];
            var tempCustomer = {
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled
            };
            var currentScore = calculateHealthScore(tempCustomer);

            var newCustomer = {
                id: Date.now(),
                name: name,
                nps: nps,
                sessionShowUp: sessionShowUp,
                messageResponseTime: messageResponseTime,
                sessionScheduled: sessionScheduled,
                participationLevel: participationLevel,
                surveyFilled: surveyFilled,
                startDate: currentDate,
                timeline: [
                    { 
                        date: currentDate, 
                        event: "Customer Onboarded", 
                        score: currentScore, 
                        type: "milestone" 
                    }
                ]
            };

            customers.push(newCustomer);
            updateDashboard();
            updateTimeFrame(); // Update timeline view

            // Clear form
            document.getElementById('name').value = '';
            document.getElementById('nps').value = '7';
            document.getElementById('showup').value = '85';
            document.getElementById('response').value = '2';
            document.getElementById('participation').value = '7';
            document.getElementById('scheduled').value = 'true';
            document.getElementById('survey').value = 'true';

            toggleForm();
            alert('Customer "' + name + '" added successfully with timeline tracking!');
        }

        // Initialize
        window.onload = function() {
            updateDashboard();
            initializeTimeFrame();
        };
    </script>
</body>
</html>